<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logistics Pro - V5.6 Full List + Stop Count</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
    :root {
        --bg: #000000; --card: #1c1c1e; --accent: #0a84ff;
        --success: #32d74b; --warning: #ffd60a; --danger: #ff453a;
        --text: #ffffff; --text-dim: #8e8e93;
    }
    /* 1. LOCK THE SCREEN SIZE */
    html, body { 
        height: 100%; margin: 0; padding: 0; overflow: hidden; 
        background: var(--bg); color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        display: flex; flex-direction: column; /* Stack items vertically */
    }
    body { padding: 8px; box-sizing: border-box; }

    /* 2. COMPACT HEADER */
    .header { display: flex; justify-content: space-between; align-items: center; height: 30px; shrink: 0; }
    .header h1 { margin: 0; font-size: 14px; color: var(--text-dim); text-transform: uppercase; }

    .prog-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin: 5px 0; flex-shrink: 0; }
    #prog-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }

    /* 3. COMPACT CARD (Top Section) */
    .card { background: var(--card); border-radius: 12px; padding: 10px; flex-shrink: 0; position: relative; }
    
    /* Smaller font for the big numbers so they fit better */
    .big-val { font-size: 50px; font-weight: 800; color: var(--success); line-height: 1; }
    
    .addr-text { 
        font-size: 18px; font-weight: 700; color: var(--accent); 
        margin: 5px 0; min-height: 45px; /* Reduced height */
        display: flex; align-items: center; justify-content: center; text-align: center;
    }
    
    .eta-box { text-align: right; color: var(--text-dim); font-size: 10px; font-weight: bold; }
    #worst-case { font-size: 14px; color: var(--danger); }
    #eta-val { font-size: 16px; color: var(--warning); }

    .btn-group { display: flex; gap: 8px; margin-top: 5px; }
    .btn-nav { flex: 1; border: none; padding: 12px; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; }

    /* 4. FLEXIBLE MAP (Takes remaining space) */
    #map-container { 
        flex: 1; /* This is the magic line: Fill remaining space */
        width: 100%; 
        position: relative; 
        border-radius: 10px; 
        overflow: hidden; 
        margin-top: 8px;
        min-height: 0; /* Important for Flexbox scrolling prevention */
    }
    #map { height: 100%; width: 100%; border: 1px solid #333; }

    /* GPS Status Footer */
    #gps-status { font-size: 9px; color: #555; text-align: center; margin-top: 4px; flex-shrink: 0; height: 12px; }

    /* Utilities */
    .arrived-alert { background: #1a321f !important; border: 2px solid var(--success); }
    #dwell-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: #333; }
    #dwell-fill { height: 100%; width: 0%; background: var(--success); }
    
    /* Overlay Styles */
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .btn-start { background: var(--accent); color: white; border: none; padding: 15px 40px; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 20px; }
    
    /* Calculator Styles (Keep these as they were) */
    .calc-input { width: 100%; background: #000; border: 1px solid #333; color: #fff; font-size: 26px; padding: 12px; border-radius: 8px; text-align: center; box-sizing: border-box; }
    .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; margin-top: 8px; }
</style>
</head>
<body>

	<button id="add-stop-btn" onclick="prepareNewStop()" 
    style="position:fixed; bottom:20px; right:10px; z-index:9999; 
           background:black; color:white; width:50px; height:50px; 
           border-radius:50%; font-size:30px; border:2px solid white; 
           cursor:pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
           display:flex; align-items:center; justify-content:center; font-weight:bold;
           transition: bottom 0.3s ease;">
    +
</button>

    <div id="overlay">
        <div id="overlay-content">
            <h2 id="route-title" style="margin-bottom: 10px; letter-spacing: 2px;">LOADING...</h2>
            <div id="day-display" style="color: #8e8e93; font-size: 14px; margin-bottom: 20px;"></div>
            <button id="start-btn" class="btn-start" onclick="startApp()">START WORK</button>
        </div>
        <div id="off-work-msg" style="display:none;">
            <h1 style="color: var(--success); font-size: 40px;">SATURDAY</h1>
            <h3>NO WORK TONIGHT</h3>
        </div>
    </div>

    <div class="header">
        <div>
            <h1>Logistics Pro</h1>
            <div id="date-box" style="font-size: 12px; font-weight:bold; color: var(--text);"></div>
        </div>
    </div>

    <div class="prog-bar"><div id="prog-fill"></div></div>

    <div class="card" id="main-card">
    <div id="dist-debug" style="position: absolute; top: 5px; left: 10px; font-size: 10px; color: var(--text-dim);">DIST: --m</div>
    <div id="skip-msg" style="position: absolute; top: 5px; right: 10px; font-size: 10px; color: var(--warning);"></div>

    <div style="display:flex; justify-content: space-between; align-items: flex-start; margin-top: 10px;">
        <div>
            <div class="big-val" id="rem-count">0</div>
            <div style="font-size: 10px; font-weight: 900; color: var(--text-dim);">DROPS LEFT</div>
        </div>
        
        <div class="eta-box">
            <div id="run-indicator" style="font-size: 12px; font-weight: 900; margin-bottom: 4px;">RUN</div>
            <div style="color: #888; font-size: 9px;">EST. FINISH</div>
            <div id="worst-case" style="color: var(--danger); font-size: 18px; font-weight: 800;">--:--</div>
            
            <div style="margin-top: 5px; line-height: 1.1;">
                <span style="font-size: 9px; color: #888;">ETA NEXT</span><br>
                <span id="eta-val" style="color: var(--warning); font-size: 16px; font-weight: 700;">--:--</span>
            </div>
        </div>
    </div>
	
	<div id="admin-trigger" onclick="checkLogin()" style="
    text-align: center; 
    font-size: 10px; 
    color: #444; 
    cursor: pointer; 
    margin-bottom: -10px; 
    letter-spacing: 2px; 
    font-weight: bold;
    z-index: 10;">
    ADMIN
</div>
    
    <div id="next-addr" class="addr-text">GPS Loading...</div>

    <div class="btn-group">
        <button class="btn-nav" style="background:#2c2c2e; color:white;" onclick="changeStop(-1)">BACK</button>
        <button class="btn-nav" style="background:var(--accent); color:white;" onclick="changeStop(1)">SKIP</button>
    </div>

    <div id="dwell-container"><div id="dwell-fill"></div></div>
</div>

   <div id="map-container">

    <button id="reset-btn" onclick="resetRoute()" style="
        position: absolute; 
        top: 10px; 
        left: 10px; 
        z-index: 1001; 
        background: #ff453a; 
        color: white; 
        border: none; 
        padding: 8px 12px; 
        border-radius: 5px; 
        font-weight: bold;">
        RESET
    </button>

    <button id="go-btn" onclick="toggle3D()" style="
        position: absolute; 
        top: 10px; 
        right: 10px; 
        z-index: 1001;
        background: var(--success); 
        color: black; 
        border: none; 
        padding: 10px 20px; 
        border-radius: 25px; 
        font-weight: 900;">
        GO
    </button>

    <button id="calc-toggle-btn" onclick="toggleCalc()" style="
        position: absolute; 
        bottom: 20px; 
        left: 10px; 
        z-index: 1001; 
        background: var(--warning); 
        color: black; 
        border: none; 
        padding: 10px 15px; 
        border-radius: 8px; 
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
        CALCULATOR
    </button>

    <div id="map" style="height: 100%; width: 100%;"></div>
</div>
    
    <div id="gps-status">GPS STANDBY</div>

    <div id="calc-backdrop" onclick="toggleCalc()" style="
    display: none; 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    background: rgba(0,0,0,0.85); 
    z-index: 1999; 
    backdrop-filter: blur(2px);">
</div>

<div id="calc-panel" class="card" style="
    display: none; 
    position: fixed; 
    top: 50%; left: 50%; 
    transform: translate(-50%, -50%); 
    width: 85%; max-width: 320px; 
    z-index: 2000; 
    border: 2px solid var(--warning); 
    box-shadow: 0 0 30px rgba(0,0,0,0.8);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0; color: var(--warning); font-size: 20px;">CALCULATOR</h2>
        <button onclick="toggleCalc()" style="background: #333; color: #888; border: none; padding: 5px 12px; border-radius: 5px; font-weight: bold; font-size: 16px;">X</button>
    </div>

    <input type="number" id="calc-in" class="calc-input" placeholder="Total Items" oninput="doCalc()" style="border: 1px solid var(--text-dim);">
    
    <div class="calc-grid" style="margin: 20px 0;">
        <div style="background: #111; padding: 10px; border-radius: 8px;">
            <span id="p-out" style="color:var(--success); font-size: 32px; font-weight: 800;">0</span><br>
            <small style="color:#888;">PACKS</small>
        </div>
        <div style="background: #111; padding: 10px; border-radius: 8px;">
            <span id="l-out" style="color:var(--warning); font-size: 32px; font-weight: 800;">0</span><br>
            <small style="color:#888;">LOOSE</small>
        </div>
    </div>

    <button onclick="toggleCalc()" style="
        width: 100%; 
        padding: 15px; 
        background: var(--warning); 
        color: black; 
        font-weight: 900; 
        font-size: 18px; 
        border: none; 
        border-radius: 8px;">
        DONE
    </button>
</div>
	
	

   <script>
    // --- 1. DATA CONTAINERS ---
    const townStops = [ 			{addr: "4a Napier Street", lat: 52.20757, lng: 0.13391},
			{addr: "17 Christchurch Street", lat: 52.20782, lng: 0.13303},
			{addr: "13 Christchurch Street", lat: 52.20760, lng: 0.13307},
			{addr: "34 Christchurch Street", lat: 52.20719, lng: 0.13311},
			{addr: "3 Willow Walk", lat: 52.20717, lng: 0.12752},
			{addr: "25 Brunswick Terrace", lat: 52.20895, lng: 0.13059},
			{addr: "17 Brunswick Terrace", lat: 52.20875, lng: 0.13067},
			{addr: "Ashtons Legal", lat: 52.20860, lng: 0.13666},
			{addr: "5a St Matthew's Gardens", lat: 52.20685, lng: 0.14145},
			{addr: "2 Ivy Court", lat: 52.20351, lng: 0.14381},
			{addr: "116 Sleaford Street", lat: 52.20391, lng: 0.14395},
			{addr: "Cambridge Women's Resource", lat: 52.20162, lng: 0.14021},
			{addr: "22 Sturton Street", lat: 52.20176, lng: 0.14070},
			{addr: "106 Sturton Street", lat: 52.20364, lng: 0.14053},
			{addr: "127 Sturton Street", lat: 52.20445, lng: 0.14025},
			{addr: "39b Abbey Walk", lat: 52.20560, lng: 0.14033},
			{addr: "20 Geldart Street", lat: 52.20555, lng: 0.13893},
			{addr: "5 Warkworth Street", lat: 52.20440, lng: 0.13027},
			{addr: "39 Warkworth Street", lat: 52.20448, lng: 0.13006},
			{addr: "26 Clarendon Street", lat: 52.20526, lng: 0.12827},
			{addr: "21 Victoria Street", lat: 52.20488, lng: 0.12719},
			{addr: "15 Elm Street", lat: 52.20596, lng: 0.12777},
			{addr: "Lensfield Hotel", lat: 52.19807, lng: 0.12360},
			{addr: "5 Pemberton Terrace", lat: 52.19692, lng: 0.12386},
			{addr: "21 Brookside", lat: 52.19700, lng: 0.12271},
			{addr: "6a Saxon Street", lat: 52.19776, lng: 0.12348},
			{addr: "6 Tennis Court Road", lat: 52.20129, lng: 0.12145},
			{addr: "Leverhulme", lat: 52.20066, lng: 0.12135},
			{addr: "3 Summerfield", lat: 52.19816, lng: 0.11149},
			{addr: "1b Summerfield", lat: 52.19833, lng: 0.11205},
			{addr: "25 Chedworth Street", lat: 52.19521, lng: 0.11156},
			{addr: "Newnham Nursery", lat: 52.19521, lng: 0.11156},
			{addr: "49 Grantchester Street", lat: 52.19416, lng: 0.11065},
			{addr: "32 Owlstone Road", lat: 52.19417, lng: 0.11132},
			{addr: "35 Owlstone Road", lat: 52.19412, lng: 0.11136},
			{addr: "50 Owlstone Road", lat: 52.19381, lng: 0.11147},
			{addr: "53 Owlstone Road", lat: 52.19361, lng: 0.11155},
			{addr: "23 Marlowe Road", lat: 52.19365, lng: 0.10797},
			{addr: "39 Eltisley Avenue", lat: 52.19443, lng: 0.10954},
			{addr: "24 Eltisley Avenue", lat: 52.19453, lng: 0.10965},
			{addr: "29 Hardwick Street", lat: 52.19557, lng: 0.10891},
			{addr: "14 Hardwick Street", lat: 52.19595, lng: 0.10894},
			{addr: "31 Millington Road", lat: 52.19470, lng: 0.10513},
			{addr: "102 Millington Lane", lat: 52.19411, lng: 0.10677},
			{addr: "8 St Marks Court", lat: 52.19712, lng: 0.10654},
			{addr: "15 St Marks Court", lat: 52.19764, lng: 0.10674},
			{addr: "45 Selwyn Road", lat: 52.19579, lng: 0.10241},
			{addr: "59 Selwyn Road", lat: 52.19583, lng: 0.10205},
			{addr: "48b Selwyn Road", lat: 52.19585, lng: 0.10142},
			{addr: "50 Selwyn Road", lat: 52.19586, lng: 0.10115},
			{addr: "3 Fulbrooke Road", lat: 52.19551, lng: 0.09958},
			{addr: "23 Fulbrooke Road", lat: 52.19563, lng: 0.09866},
			{addr: "25 Fulbrooke Road", lat: 52.19564, lng: 0.09858},
			{addr: "30 Fulbrooke Road", lat: 52.19566, lng: 0.09849},
			{addr: "34 Fulbrooke Road", lat: 52.19569, lng: 0.09823},
			{addr: "37 Fulbrooke Road", lat: 52.19569, lng: 0.09810},
			{addr: "33 Grantchester Road", lat: 52.19597, lng: 0.10047},
			{addr: "16 Grantchester Road", lat: 52.19614, lng: 0.10046},
			{addr: "29 Grantchester Road", lat: 52.19619, lng: 0.10047},
			{addr: "81 Barton Road", lat: 52.19762, lng: 0.09981},
			{addr: "86b Barton Road", lat: 52.19797, lng: 0.09845},
			{addr: "110 Barton Road", lat: 52.19855, lng: 0.09554},
			{addr: "University Laundry Farm", lat: 52.19743, lng: 0.08728},
			{addr: "12 Stukeley Close", lat: 52.19919, lng: 0.09693},
			{addr: "15 Gough Way", lat: 52.19990, lng: 0.09745},
			{addr: "41 Gough Way", lat: 52.19974, lng: 0.09465},
			{addr: "66 Gough Way", lat: 52.20031, lng: 0.09439},
			{addr: "67 Gough Way", lat: 52.20096, lng: 0.09441},
			{addr: "77 Gough Way", lat: 52.20177, lng: 0.09457},
			{addr: "79 Gough Way", lat: 52.20184, lng: 0.09462},
			{addr: "4 Spens Avenue", lat: 52.19967, lng: 0.09938},
			{addr: "57 Barton Road", lat: 52.19706, lng: 0.10232},
			{addr: "11 Barton Close", lat: 52.19782, lng: 0.10267},
			{addr: "13 Archway Court", lat: 52.19659, lng: 0.10310},
			{addr: "Monkey Puzzle Nursery", lat: 52.19788, lng: 0.10484},
			{addr: "Tyndale Lodge", lat: 52.19886, lng: 0.10357},
			{addr: "5a Selwyn Gardens", lat: 52.19968, lng: 0.10283},
			{addr: "4 Grange Court", lat: 52.20115, lng: 0.10422},
			{addr: "4 Marleborough Court", lat: 52.20065, lng: 0.10239},
			{addr: "5 Marleborough Court", lat: 52.20065, lng: 0.10239},
			{addr: "9a Herschel Road", lat: 52.20473, lng: 0.10073},
			{addr: "3 Adams Road", lat: 52.20614, lng: 0.10400},
			{addr: "Marks & Clerk", lat: 52.19660, lng: 0.12912},
			{addr: "WSP", lat: 52.19655, lng: 0.12982},
			{addr: "21 Bateman Street", lat: 52.19541, lng: 0.12776},
			{addr: "University Cambridge Investment", lat: 52.19560, lng: 0.13070},
			{addr: "4 Claremont", lat: 52.19553, lng: 0.13119},
			{addr: "23 George Patemen Court", lat: 52.19582, lng: 0.13399},
			{addr: "7 Tenison Avenue", lat: 52.19647, lng: 0.13424},
			{addr: "41 Highsett", lat: 52.19643, lng: 0.13248},
			{addr: "11 Lyndewode Road", lat: 52.19723, lng: 0.13304},
			{addr: "26 Lyndewode Road", lat: 52.19721, lng: 0.13384},
			{addr: "8 St Barnabas Road", lat: 52.19720, lng: 0.13672},
			{addr: "15 St Barnabas Road", lat: 52.19681, lng: 0.13752},
			{addr: "33 St Barnabas Road", lat: 52.19809, lng: 0.13732},
			{addr: "38 St Barnabas Road", lat: 52.19809, lng: 0.13732},
			{addr: "39 St Barnabas Road", lat: 52.19830, lng: 0.13745},
			{addr: "68 St Barnabas Road", lat: 52.19876, lng: 0.13779},
			{addr: "184 Gwydir Street", lat: 52.20016, lng: 0.13855},
			{addr: "123 Gwydir Street", lat: 52.20158, lng: 0.13918},
			{addr: "91 Gwydir Street", lat: 52.20226, lng: 0.13932},
			{addr: "72 Kingston Street", lat: 52.20090, lng: 0.14016},
			{addr: "19 Eagle Street", lat: 52.20035, lng: 0.14126},
			{addr: "57 Tenison Road", lat: 52.19854, lng: 0.13577},
			{addr: "63 Tenison Road", lat: 52.19838, lng: 0.13568},
			{addr: "28 Emery Street", lat: 52.20133, lng: 0.13597},
			{addr: "18 Guest Road", lat: 52.20200, lng: 0.13470},
			{addr: "48 Glisson Road", lat: 52.19873, lng: 0.13353},
			{addr: "53 Glisson Road", lat: 52.19840, lng: 0.13310},
			{addr: "79 Hills Road", lat: 52.19395, lng: 0.13248},
			{addr: "123 Hills Road", lat: 52.19286, lng: 0.13341}, ];
    const villageStops = [             {addr: "27 Priory Rd", lat: 52.23886, lng: 0.18287},
    {addr: "The Old Vicarage", lat: 52.23959, lng: 0.18611},
    {addr: "Riverside House", lat: 52.25652, lng: 0.19857},
    {addr: "49 Station Rd", lat: 52.26347, lng: 0.19572},
    {addr: "5 Payton Way", lat: 52.26458, lng: 0.19597},
    {addr: "26 Burgess Rd", lat: 52.26555, lng: 0.19787},
    {addr: "13 Way Lane", lat: 52.26647, lng: 0.19322},
    {addr: "44 Way Lane", lat: 52.26759, lng: 0.1935},
    {addr: "Bank Farmhouse", lat: 52.29097, lng: 0.22095},
    {addr: "The Willows", lat: 52.27908, lng: 0.21055},
    {addr: "71 Capper Rd", lat: 52.2734, lng: 0.20122},
    {addr: "Little Stars Nursery", lat: 52.27398, lng: 0.19717},
    {addr: "11 Capper Rd", lat: 52.2737, lng: 0.19677},
    {addr: "8 Heron Walk", lat: 52.27266, lng: 0.19137},
    {addr: "5 Providence Way", lat: 52.27232, lng: 0.18788},
    {addr: "23 Providence Way", lat: 52.27316, lng: 0.18814},
    {addr: "53 Denny End Rd", lat: 52.27207, lng: 0.1849},
    {addr: "55 Denny End Rd", lat: 52.27207, lng: 0.1849},
    {addr: "57 Denny End Rd", lat: 52.27207, lng: 0.1849},
    {addr: "2 Cookes Field", lat: 52.27127, lng: 0.18566},
    {addr: "Romil", lat: 52.27125, lng: 0.18146},
    {addr: "6 Jubilee Cl", lat: 52.27052, lng: 0.18785},
    {addr: "14 Jubilee Cl", lat: 52.27117, lng: 0.18823},
    {addr: "3 Vicarage Cl", lat: 52.26729, lng: 0.18968},
    {addr: "29 Vicarage Cl", lat: 52.26715, lng: 0.18777},
    {addr: "16 Cambridge Rd", lat: 52.26527, lng: 0.18853},
    {addr: "15 Cambridge Rd", lat: 52.26513, lng: 0.18828},
    {addr: "48 Cambridge Rd", lat: 52.264, lng: 0.18745},
    {addr: "70 Cambridge Rd", lat: 52.26368, lng: 0.186},
    {addr: "139 Waterbeach Rd", lat: 52.26385, lng: 0.17764},
    {addr: "127 Waterbeach Rd", lat: 52.26392, lng: 0.17666},
    {addr: "87 Waterbeach Rd", lat: 52.26398, lng: 0.17139},
    {addr: "8a Matthew Parker Cl", lat: 52.26336, lng: 0.16472},
    {addr: "1 Abrahams Cl", lat: 52.26335, lng: 0.16326},
    {addr: "14 Abrahams Cl", lat: 52.26335, lng: 0.16354},
    {addr: "11 Abrahams Cl", lat: 52.2633, lng: 0.1638},
    {addr: "12 Abrahams Cl", lat: 52.2633, lng: 0.1638},
    {addr: "47 High St", lat: 52.26229, lng: 0.1632},
    {addr: "The Silver Cloud", lat: 52.25701, lng: 0.16358},
    {addr: "22 David Bull Way", lat: 52.24599, lng: 0.16165},
    {addr: "40 Sutton Cl", lat: 52.24756, lng: 0.16085},
    {addr: "26 Sutton Cl", lat: 52.2477, lng: 0.16161},
    {addr: "12 Burling Walk", lat: 52.24736, lng: 0.15956},
    {addr: "17 Froment Way", lat: 52.24669, lng: 0.15809},
    {addr: "3 Butcher Cl", lat: 52.2458, lng: 0.15548},
    {addr: "7 Butcher Cl", lat: 52.24559, lng: 0.15537},
    {addr: "4 Bulteel Cl", lat: 52.24603, lng: 0.15779},
    {addr: "43 Willow Cres", lat: 52.24519, lng: 0.16362},
    {addr: "9 Goding Way", lat: 52.24299, lng: 0.16687},
    {addr: "15 Pearson Cl", lat: 52.24069, lng: 0.16662},
    {addr: "6 Milton Court", lat: 52.24374, lng: 0.16324},
    {addr: "2 Old School Ln", lat: 52.24247, lng: 0.16326},
    {addr: "14 Old School Ln", lat: 52.24216, lng: 0.16396},
    {addr: "58 Old School Ln", lat: 52.24089, lng: 0.16562},
    {addr: "57 Old School Ln", lat: 52.24126, lng: 0.16583},
    {addr: "21 Old School Ln", lat: 52.24208, lng: 0.16413},
    {addr: "64 Coles Rd", lat: 52.24193, lng: 0.16212},
    {addr: "27 Walkling Way", lat: 52.24157, lng: 0.16067},
    {addr: "11 High St", lat: 52.24317, lng: 0.16094},
    {addr: "9 Fox's Cl", lat: 52.24435, lng: 0.16081},
    {addr: "Tanglin Butt Ln", lat: 52.24417, lng: 0.15843},
    {addr: "7 Lyndhurst Cl", lat: 52.244945, lng: 0.157853},
    {addr: "49 Butt Ln", lat: 52.244748, lng: 0.155536},
    {addr: "272 The Rowans", lat: 52.241552, lng: 0.157757},
    {addr: "37 The Oaks", lat: 52.243552, lng: 0.157537},
    {addr: "27 The Oaks", lat: 52.243303, lng: 0.157231},
    {addr: "10 The Elms", lat: 52.243211, lng: 0.155992},
    {addr: "22 The Elms", lat: 52.24371, lng: 0.156362},
    {addr: "13 The Elms", lat: 52.243641, lng: 0.156308},
    {addr: "235 The Rowans", lat: 52.242554, lng: 0.155032},
    {addr: "190 The Rowans", lat: 52.242048, lng: 0.156791},
    {addr: "118 The Rowans", lat: 52.24143, lng: 0.15597},
    {addr: "120 The Rowans", lat: 52.24143, lng: 0.156099},
    {addr: "14 The Sycamores", lat: 52.240944, lng: 0.15354},
    {addr: "62 The Rowans", lat: 52.240346, lng: 0.154806},
    {addr: "30 The Rowans", lat: 52.2392, lng: 0.155515},
    {addr: "12 Benet Cl", lat: 52.240221, lng: 0.1564},
    {addr: "38 North Lodge pk", lat: 52.245224, lng: 0.168459},
    {addr: "Enterprise House", lat: 52.255674, lng: 0.175942},
    {addr: "The Retreat", lat: 52.255934, lng: 0.176012},
    {addr: "82 Green End Rd", lat: 52.27103, lng: 0.163025},
    {addr: "Alborough Farm", lat: 52.2931, lng: 0.15483},
    {addr: "73 Racecourse View", lat: 52.28598, lng: 0.13563},
    {addr: "39 Beach Rd", lat: 52.28531, lng: 0.13114},
    {addr: "30 Leopold Walk", lat: 52.28434, lng: 0.12478},
    {addr: "13 Brenda Gautrey Way", lat: 52.28495, lng: 0.12842},
    {addr: "1 Calvin Cl", lat: 52.28582, lng: 0.13417},
    {addr: "10 Beach Rd", lat: 52.28635, lng: 0.13011},
    {addr: "116 Rooks St", lat: 52.28663, lng: 0.12918},
    {addr: "106 Rooks St", lat: 52.28684, lng: 0.12905},
    {addr: "87a Rooks St", lat: 52.28744, lng: 0.13076},
    {addr: "58 Denmark Rd", lat: 52.28608, lng: 0.12911},
    {addr: "56 Denmark Rd", lat: 52.2861, lng: 0.12873},
    {addr: "32 Denmark Rd", lat: 52.28555, lng: 0.12728},
    {addr: "1a Cundell Dr", lat: 52.28729, lng: 0.12824},
    {addr: "7 Cundell Dr", lat: 52.28748, lng: 0.12912},
    {addr: "7 Corbett St", lat: 52.28808, lng: 0.1265},
    {addr: "19 Corbett St", lat: 52.28803, lng: 0.12751},
    {addr: "The Gables", lat: 52.28885, lng: 0.13071},
    {addr: "48 Rooks St", lat: 52.28869, lng: 0.1293},
    {addr: "55 Margett St", lat: 52.28844, lng: 0.12833},
    {addr: "30 Margett St", lat: 52.28892, lng: 0.12788},
    {addr: "11 Margett St", lat: 52.28957, lng: 0.12676},
    {addr: "153 High St", lat: 52.2903, lng: 0.12648},
    {addr: "148 High St", lat: 52.29048, lng: 0.12648},
    {addr: "140 High St", lat: 52.29085, lng: 0.12686},
    {addr: "15 Courtyard Way", lat: 52.29334, lng: 0.12544},
    {addr: "19 Courtyard Way", lat: 52.29343, lng: 0.12564},
    {addr: "13 Courtyard Way", lat: 52.29331, lng: 0.1256},
    {addr: "7 Moores Court", lat: 52.29244, lng: 0.12589},
    {addr: "8 Moores Court", lat: 52.29243, lng: 0.12582},
    {addr: "31 Broad Lane", lat: 52.29228, lng: 0.12534},
    {addr: "14 Tenison Manor", lat: 52.29212, lng: 0.12317},
    {addr: "11 Woodlark Dr", lat: 52.2907, lng: 0.1217},
    {addr: "30 Woodlark Dr", lat: 52.2906, lng: 0.12134},
    {addr: "8 The Herons", lat: 52.28971, lng: 0.12378},
    {addr: "27 Kestrel Cl", lat: 52.29125, lng: 0.12517},
    {addr: "15 Bullfinch Way", lat: 52.29162, lng: 0.12465},
    {addr: "92 High St", lat: 52.29286, lng: 0.12867},
    {addr: "83 High St", lat: 52.29306, lng: 0.12901},
    {addr: "71 High St", lat: 52.29366, lng: 0.12939},
    {addr: "2 Ivatt St", lat: 52.29402, lng: 0.12937},
    {addr: "5 Ivatt St", lat: 52.29426, lng: 0.12888},
    {addr: "38 Ivatt St", lat: 52.2951, lng: 0.12783},
    {addr: "41 High St", lat: 52.29452, lng: 0.13018},
    {addr: "Screens & Graphics", lat: 52.29544, lng: 0.13126},
    {addr: "19 High St", lat: 52.29564, lng: 0.13127},
    {addr: "13 High St", lat: 52.29592, lng: 0.13162},
    {addr: "Wooden House", lat: 52.29787, lng: 0.1325},
    {addr: "Voland Roofing", lat: 52.2982, lng: 0.13321},
    {addr: "DB Technology", lat: 52.30256, lng: 0.14977},
    {addr: "Lost Acres", lat: 52.30385, lng: 0.15248},
    {addr: "4 Beagle Court", lat: 52.28788, lng: 0.12562},
    {addr: "277 High St", lat: 52.28618, lng: 0.12619},
    {addr: "7 Lacks Cl", lat: 52.28529, lng: 0.12366},
    {addr: "324 High St", lat: 52.28373, lng: 0.12227},
    {addr: "330 High St", lat: 52.28351, lng: 0.12187},
    {addr: "7 Ellis Cl", lat: 52.28248, lng: 0.11956},
    {addr: "20 Rampton Rd", lat: 52.28325, lng: 0.11935},
    {addr: "1a Oakington Rd", lat: 52.28344, lng: 0.1177},
    {addr: "11 Worland Way", lat: 52.28389, lng: 0.11429},
    {addr: "6 The Rowells", lat: 52.28325, lng: 0.11407},
    {addr: "47 Clarke Cl", lat: 52.28244, lng: 0.11043},
    {addr: "92 Clarke Cl", lat: 52.28435, lng: 0.11391},
    {addr: "4 New Close", lat: 52.28434, lng: 0.11791},
    {addr: "75 Rampton Rd", lat: 52.28491, lng: 0.11591},
    {addr: "86 Rampton Rd", lat: 52.28556, lng: 0.1152},
    {addr: "113 Rampton Rd", lat: 52.28618, lng: 0.11288},
    {addr: "67 Groves Way", lat: 52.28461, lng: 0.11226},
    {addr: "88 Lambs Ln", lat: 52.28568, lng: 0.117},
    {addr: "8 Pelham Way", lat: 52.28533, lng: 0.11856},
    {addr: "4 Wilkin Walk", lat: 52.28466, lng: 0.12267},
    {addr: "18 Wilkin Walk", lat: 52.285, lng: 0.12213},
    {addr: "46 Wilkin Walk", lat: 52.28652, lng: 0.13161},
    {addr: "49 Pelham Way", lat: 52.28389, lng: 0.12056},
    {addr: "62 Lambs Ln", lat: 52.28282, lng: 0.12461},
    {addr: "Ladybird Nursery", lat: 52.28312, lng: 0.12561},
    {addr: "Chestnut Nursery", lat: 52.28332, lng: 0.12631},
    {addr: "Cottenham Primary", lat: 52.28352, lng: 0.12691},
    {addr: "31 Victory Way", lat: 52.28422, lng: 0.12761},
    {addr: "30 Lambs Ln", lat: 52.28452, lng: 0.12831},
    {addr: "21 Victory Way", lat: 52.28482, lng: 0.12891},
    {addr: "5 Lambs Row", lat: 52.28522, lng: 0.12961},
    {addr: "7 Harlestones Rd", lat: 52.28582, lng: 0.13031},
    {addr: "21 Franklin Gardens", lat: 52.28722, lng: 0.13291},
    {addr: "38 Franklin Gardens", lat: 52.28752, lng: 0.13361},
    {addr: "17 Lyles Rd", lat: 52.28822, lng: 0.13461},
    {addr: "16 Lyles Rd", lat: 52.28852, lng: 0.13531},
    {addr: "6 Lyles Rd", lat: 52.28912, lng: 0.13631},
    {addr: "1 Staff House", lat: 52.28982, lng: 0.13561},
    {addr: "2 Morgans", lat: 52.28852, lng: 0.13831},
    {addr: "3 Foundry Cl", lat: 52.28722, lng: 0.13961},
    {addr: "41 Dunstall Field", lat: 52.28582, lng: 0.14131},
    {addr: "15 Dunstall Field", lat: 52.28522, lng: 0.14191},
    {addr: "14 Dunstall Field", lat: 52.28512, lng: 0.14211},
    {addr: "38 Dunstall Field", lat: 52.28552, lng: 0.14261},
    {addr: "27 Dunstall Field", lat: 52.28542, lng: 0.14231},
    {addr: "34 Histon Rd", lat: 52.28352, lng: 0.14391},
    {addr: "108 Cottenham Road", lat: 52.26089, lng: 0.11011},
    {addr: "Histon & Impington Park Primary School", lat: 52.2589, lng: 0.10998},
    {addr: "25 Garden Walk", lat: 52.2568, lng: 0.11153},
    {addr: "49 Orchard Road", lat: 52.25549, lng: 0.11058},
    {addr: "24 Orchard Road", lat: 52.25526, lng: 0.11256},
    {addr: "22 Orchard Road", lat: 52.25526, lng: 0.11256},
    {addr: "6 Orchard Road", lat: 52.25486, lng: 0.11363},
    {addr: "66 Mill Lane", lat: 52.25462, lng: 0.11357},
    {addr: "12 Spring Close", lat: 52.25455, lng: 0.11077},
    {addr: "28 Mill Lane", lat: 52.2536, lng: 0.1119},
    {addr: "15 Impington Lane", lat: 52.25086, lng: 0.1098},
    {addr: "19 Impington Lane", lat: 52.25082, lng: 0.10996},
    {addr: "55 Hereward Close", lat: 52.2492, lng: 0.11113},
    {addr: "169 Hereward Close", lat: 52.24796, lng: 0.11084},
    {addr: "22 Hereward Close", lat: 52.25007, lng: 0.11016},
    {addr: "60 Merrington Place", lat: 52.25156, lng: 0.1113},
    {addr: "54 Impington Lane", lat: 52.24976, lng: 0.11397},
    {addr: "2 St Georges Way", lat: 52.25091, lng: 0.12566},
    {addr: "5 St Georges Court", lat: 52.25119, lng: 0.12594},
    {addr: "14 Roselea", lat: 52.24837, lng: 0.11476},
    {addr: "42 Pages Close", lat: 52.25492, lng: 0.10958},
    {addr: "47 Parlour Close", lat: 52.25778, lng: 0.10882},
    {addr: "1 Oates Way", lat: 52.25723, lng: 0.10724},
    {addr: "6 Farmstead Close", lat: 52.25749, lng: 0.10664},
    {addr: "10 Greenleas", lat: 52.25767, lng: 0.10574},
    {addr: "17 Nuns Orchard", lat: 52.2552, lng: 0.10506},
    {addr: "12 Nuns Orchard", lat: 52.25501, lng: 0.10539},
    {addr: "1 Kingsway", lat: 52.25505, lng: 0.10541},
    {addr: "24 Clay Street", lat: 52.25578, lng: 0.10621},
    {addr: "8 Kingsway", lat: 52.25578, lng: 0.10621},
    {addr: "7 Prior's Close", lat: 52.25325, lng: 0.10682},
    {addr: "12 Church Street", lat: 52.25516, lng: 0.10381},
    {addr: "13 Park Lane", lat: 52.25352, lng: 0.10101},
    {addr: "7 Pease Way", lat: 52.25417, lng: 0.09327},
    {addr: "36 Park Avenue", lat: 52.25161, lng: 0.10003},
    {addr: "51 Park Avenue", lat: 52.25096, lng: 0.0998},
    {addr: "17 Shirley Road", lat: 52.25108, lng: 0.10132},
    {addr: "19 Shirley Road", lat: 52.25108, lng: 0.10132},
    {addr: "15 Somerset Road", lat: 52.25022, lng: 0.10214},
    {addr: "43 Merton Road", lat: 52.25161, lng: 0.10318},
    {addr: "51 Home Close", lat: 52.24952, lng: 0.10353},
    {addr: "Histon & Impington Brook Primary School", lat: 52.25296, lng: 0.10783},
    {addr: "19 Station Road", lat: 52.25065, lng: 0.10676},
    {addr: "59 Station Road", lat: 52.2485, lng: 0.10779},
    {addr: "Histon Early Years", lat: 52.24809, lng: 0.10731},
    {addr: "71 Station Road", lat: 52.24768, lng: 0.10871},
    {addr: "93 Station Road", lat: 52.24655, lng: 0.10899},
    {addr: "Sol Business", lat: 52.2445, lng: 0.10894},
    {addr: "7 Pioneer Court", lat: 52.24541, lng: 0.10531},
    {addr: "33 Cambridge Road", lat: 52.24066, lng: 0.11062},
    {addr: "45 Cambridge Road", lat: 52.24024, lng: 0.1105},
    {addr: "10 Cooke Walk", lat: 52.23897, lng: 0.10686},
    {addr: "62 South Road", lat: 52.24016, lng: 0.10613},
    {addr: "54 South Road", lat: 52.24062, lng: 0.10617},
    {addr: "3 College Road", lat: 52.24096, lng: 0.1078},
    {addr: "4 Villa Place", lat: 52.2425, lng: 0.10919},
    {addr: "Camtrust 22", lat: 52.23891, lng: 0.1101},
    {addr: "5 Cresswell Close", lat: 52.23821, lng: 0.10655},
    {addr: "31 Lone Tree", lat: 52.23605, lng: 0.10801}];

    // --- 2. GLOBAL VARIABLES ---
    let stops = [];
    let index = 0;
    let map, userMarker, routeLine, dwellTimer, recenterTimer;
    let stopMarkers = []; 
    let lastLat = 52.238, lastLng = 0.182; 
    let isUserMovingMap = false;
    let countdownActive = false;
	let isAdmin = false;
    let markersMoved = false;
	
    const TRIGGER_DIST = 7; // Slightly wider to help with "Skip Ahead" detection

    window.onload = function() {
        const now = new Date();
        let bizDate = new Date(now);
		
        
        // Keep it on "Thursday Night" until 4 PM Friday
        if (now.getHours() < 20) {
            bizDate.setDate(now.getDate() - 1);
        }

        const scheduleDay = bizDate.getDay(); 
        const routeTitle = document.getElementById('route-title');
        const runInd = document.getElementById('run-indicator');
        const calcBtn = document.getElementById('calc-toggle-btn');

        document.getElementById('date-box').innerText = bizDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' }).toUpperCase();
        document.getElementById('day-display').innerText = bizDate.toLocaleDateString('en-GB', { weekday: 'long' }).toUpperCase();

        if (scheduleDay === 6) {
            document.getElementById('overlay-content').style.display = 'none';
            document.getElementById('off-work-msg').style.display = 'block';
            return;
        }

        // Logic based on your specific schedule
        const isVillageNight = (scheduleDay === 0 || scheduleDay === 2 || scheduleDay === 4);
        stops = isVillageNight ? villageStops : townStops;
        
        if (routeTitle) routeTitle.innerText = isVillageNight ? "VILLAGE RUN" : "TOWN RUN";
        if (runInd) {
            runInd.innerText = isVillageNight ? "VILLAGE" : "TOWN";
            runInd.style.color = isVillageNight ? "#ff453a" : "#0a84ff";
        }

        // Only show the CALC button on map if it's a Village night
        if (calcBtn) calcBtn.style.display = isVillageNight ? 'block' : 'none';

        const saved = localStorage.getItem('log_nav_idx');
        const startBtn = document.getElementById('start-btn');
        if (saved !== null && stops.length > 0) {
            index = Math.min(parseInt(saved), stops.length - 1);
            startBtn.innerText = "RESUME AT STOP " + (index + 1);
        } else {
            startBtn.innerText = stops.length > 0 ? "START WORK" : "NO STOPS FOUND";
        }
    };

    async function startApp() {
        if (stops.length === 0) return;
        document.getElementById('overlay').style.display = 'none';
        initMap();
        initGPS();
        updateUI();
    }

    // --- 4. MAP & GPS ---
    function initMap() {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([stops[0].lat, stops[0].lng], 17);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
        
        stops.forEach((stop, i) => {
            const marker = L.circleMarker([stop.lat, stop.lng], {
                radius: 6, fillColor: (i === index) ? "#ff453a" : "#ffd60a",
                color: "#fff", weight: 1, fillOpacity: 1
            }).addTo(map);
            stopMarkers.push(marker);
        });

        routeLine = L.polyline([], { color: '#0a84ff', weight: 8, opacity: 0.8 }).addTo(map);
        userMarker = L.circleMarker([0,0], { radius: 10, fillColor: "#fff", color: "#0a84ff", weight: 4, fillOpacity: 1 }).addTo(map);
        
        map.on('movestart', () => { isUserMovingMap = true; clearTimeout(recenterTimer); });
        map.on('moveend', () => { recenterTimer = setTimeout(() => { isUserMovingMap = false; recenterView(); }, 10000); });
    }

    function recenterView() {
        if (isUserMovingMap || !stops[index]) return;
        const bounds = L.latLngBounds([L.latLng(lastLat, lastLng), L.latLng(stops[index].lat, stops[index].lng)]);
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 18 });
    }

    function initGPS() {
        navigator.geolocation.watchPosition(pos => {
            lastLat = pos.coords.latitude;
            lastLng = pos.coords.longitude;
            userMarker.setLatLng([lastLat, lastLng]);
            
            // SMART SCAN: Check all remaining stops to see if we've skipped ahead
            for (let i = index; i < stops.length; i++) {
                let d = getDist(lastLat, lastLng, stops[i].lat, stops[i].lng);
                if (d < TRIGGER_DIST) {
                if (!countdownActive) {
                    index = i;
                    startHiddenCountdown();
                    break;
                }
            } else if (i === index && countdownActive) {
                // STOP TIMER IF YOU LEAVE THE AREA
                clearInterval(dwellTimer);
                countdownActive = false;
                document.getElementById('dwell-fill').style.width = '0%';
                document.getElementById('main-card').classList.remove('arrived-alert');
            }
            }

            document.getElementById('gps-status').innerText = `GPS ACTIVE (${Math.round(pos.coords.accuracy)}m)`;
            if (!isUserMovingMap) recenterView();
            fetchRoute();
        }, null, { enableHighAccuracy: true });
    }

// --- 5. NAV & ALL-STOP ESTIMATE (1.4x Multiplier) ---
async function fetchRoute() {
    const remainingStops = stops.slice(index); 
    const estFinishElem = document.getElementById('worst-case');
    const etaNextElem = document.getElementById('eta-val');
    
    if (remainingStops.length === 0) return;

    const now = Date.now();
    // Immediate baseline so no dashes appear
    const baselineFinish = new Date(now + (remainingStops.length * 120 * 1000));
    if (estFinishElem) {
        estFinishElem.innerText = baselineFinish.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    if (lastLat === null || lastLng === null) return;

    try {
        // Build coordinates for ALL stops to get total time
        const coords = `${lastLng},${lastLat};` + 
                       remainingStops.map(s => `${s.lng},${s.lat}`).join(';');

        const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson&steps=true`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.routes && data.routes[0]) {
            const route = data.routes[0];
            
            // --- THE MAP FIX: ONLY DRAW LEG 0 ---
            // This filters the geometry to only show the path to the NEXT stop
            // while still using the full route duration for the math below.
            const nextStopSteps = route.legs[0].steps;
            const nextStopCoords = [];
            nextStopSteps.forEach(step => {
                step.intersections.forEach(inter => {
                    nextStopCoords.push([inter.location[1], inter.location[0]]);
                });
            });
            routeLine.setLatLngs(nextStopCoords);

            // --- THE MATH (1.4x Multiplier for the whole night) ---
            const totalDrivingSeconds = route.duration;
            const bufferedDrivingSeconds = totalDrivingSeconds * 1.4; 
            const totalServiceSeconds = remainingStops.length * 120; 
            
            const totalSecondsTillFinish = bufferedDrivingSeconds + totalServiceSeconds;

            // UPDATE EST. FINISH
            const finalFinish = new Date(now + (totalSecondsTillFinish * 1000));
            if (estFinishElem) {
                estFinishElem.innerText = finalFinish.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }

            // UPDATE ETA NEXT (First leg only x 1.4 + 2 mins)
            const firstLegSeconds = (route.legs[0].duration * 1.4) + 120;
            const nextETA = new Date(now + (firstLegSeconds * 1000));
            if (etaNextElem) {
                etaNextElem.innerText = nextETA.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }

            // DIRECTIONS (Leg 0 only)
            const steps = route.legs[0].steps;
            let dirText = "HEAD TOWARD STOP";
            if (steps.length > 1) {
                const t = steps[1]; 
                dirText = `IN ${Math.round(t.distance)}m: TAKE ${t.maneuver.modifier || 'TURN'} ONTO ${t.name || 'ROAD'}`;
            }
            document.getElementById('direction-text').innerText = dirText.toUpperCase();
        }
    } catch (e) { 
        console.error("Route Logic Error:", e); 
    }
}

    // --- 6. CORE APP LOGIC ---
    function startHiddenCountdown() {
        countdownActive = true;
        document.getElementById('main-card').classList.add('arrived-alert');
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]); 
        let time = 0;
        dwellTimer = setInterval(() => {
            time += 1; 
            document.getElementById('dwell-fill').style.width = time + "%";
            if (time >= 100) {
                clearInterval(dwellTimer);
                document.getElementById('main-card').classList.remove('arrived-alert');
                document.getElementById('dwell-fill').style.width = "0%";
                index++; // Move to the NEXT stop after the one we just arrived at
                countdownActive = false;
                updateUI();
            }
        }, 100);
    }

    function updateUI() {
        if (index >= stops.length) {
            document.getElementById('next-addr').innerText = "ROUTE COMPLETE";
            document.getElementById('rem-count').innerText = "0";
            return;
        }
        document.getElementById('next-addr').innerText = stops[index].addr;
        document.getElementById('rem-count').innerText = stops.length - index;
        document.getElementById('prog-fill').style.width = ((index / stops.length) * 100) + "%";
        localStorage.setItem('log_nav_idx', index);
        
        stopMarkers.forEach((m, i) => {
            if (i === index) m.setStyle({fillColor: "#ff453a", radius: 10});
            else if (i < index) m.setStyle({fillColor: "#444", radius: 5});
            else m.setStyle({fillColor: "#ffd60a", radius: 6});
        });
        recenterView();
        fetchRoute();
    }

    function getDist(l1, n1, l2, n2) {
        const R = 6371000;
        const dLat = (l2-l1) * Math.PI/180;
        const dLon = (n2-n1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function changeStop(dir) {
Â  Â  Â  Â  index += dir;
Â  Â  Â  Â  if (index < 0) index = 0;
Â  Â  Â  Â  if (index >= stops.length) index = stops.length - 1;
Â  Â  Â  Â Â 
Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  saveProgress();
Â  Â  }

function toggle3D() {
        const s = stops[index];
        const url = `https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}&travelmode=driving`;
        window.open(url, '_blank');
    }

    function doCalc() {
        let v = document.getElementById('calc-in').value;
        document.getElementById('p-out').innerText = v ? Math.floor(v / 18) : 0;
        document.getElementById('l-out').innerText = v ? v % 18 : 0;
    }

    function resetRoute() {
        if (confirm("Reset route to Stop 1?")) {
            index = 0;
            localStorage.setItem('log_nav_idx', 0);
            updateUI();
        }
    }
	
	function toggleCalc() {
    const panel = document.getElementById('calc-panel');
    const backdrop = document.getElementById('calc-backdrop');
    const inputField = document.getElementById('calc-in');
    
    // Check if hidden
    const isHidden = (panel.style.display === 'none' || panel.style.display === '');

    if (isHidden) {
        // OPEN IT
        panel.style.display = 'block';
        backdrop.style.display = 'block';
        
        // Reset the input value for a fresh calculation? 
        // Remove the next line if you want to keep the old numbers.
        inputField.value = ''; 
        document.getElementById('p-out').innerText = '0';
        document.getElementById('l-out').innerText = '0';

        // Focus the keyboard automatically
        setTimeout(() => { inputField.focus(); }, 100);
    } else {
        // CLOSE IT
        panel.style.display = 'none';
        backdrop.style.display = 'none';
    }
}
function openNav() {
    if (index < stops.length) {
        const dest = stops[index];
        const url = `https://www.google.com/maps/dir/?api=1&destination=${dest.lat},${dest.lng}&travelmode=driving`;
        window.open(url, '_blank');
    }
}

// When creating markers in your setup loop, ensure they have tooltips:
function addMarkerTooltips() {
    stopMarkers.forEach((marker, i) => {
        marker.bindTooltip(stops[i].addr, {
            direction: 'top',
            offset: [0, -10],
            opacity: 0.9
        });
    });
}

// --- 1. THE RE-LOGIN LOOP ---
// This keeps checking until the map is ready, then logs you in automatically.
const adminCheckInterval = setInterval(() => {
    if (localStorage.getItem('adminSession') === 'active') {
        // Only trigger if the map and markers are actually loaded
        if (typeof map !== 'undefined' && typeof stopMarkers !== 'undefined' && stopMarkers.length > 0) {
            activateAdmin(true);
            clearInterval(adminCheckInterval); // Stop checking once logged in
        }
    } else {
        clearInterval(adminCheckInterval); // Stop if no session found
    }
}, 500);

function checkLogin() {
    const pass = prompt("Enter Admin Password:");
    if (pass === "1234") { 
        const remember = confirm("Remember me on this device?");
        if (remember) {
            localStorage.setItem('adminSession', 'active');
        }
        activateAdmin();
    } else {
        alert("Incorrect Password");
    }
}

function activateAdmin(isSilent = false) {
    isAdmin = true;
    const trigger = document.getElementById('admin-trigger');
    if (trigger) {
        trigger.innerText = "ADMIN: DRAGGING ACTIVE";
        trigger.style.color = "var(--success)";
    }
    
    // Move the Plus button UP to make room for Logout
    const addBtn = document.getElementById('add-stop-btn');
    if (addBtn) {
        addBtn.style.bottom = "100px"; // Moves it above the logout button
    }

    if (!document.getElementById('logout-btn')) {
        const logoutBtn = document.createElement('button');
        logoutBtn.id = 'logout-btn';
        logoutBtn.innerText = "ðŸ”’ LOGOUT";
        // Logout button stays at the very bottom (20px)
        logoutBtn.style = "position:fixed; bottom:20px; right:10px; z-index:9999; background:#ff4444; color:white; padding:10px; border-radius:8px; font-weight:bold; border:none; cursor:pointer; width:100px;";
        logoutBtn.onclick = logout;
        document.body.appendChild(logoutBtn);
    }

    // Refresh markers to make them draggable (as before)
    stopMarkers.forEach((marker, i) => {
        const pos = marker.getLatLng();
        const addr = stops[i].addr;
        map.removeLayer(marker); 

        let newMarker = L.marker([pos.lat, pos.lng], {
            draggable: true,
            riseOnHover: true
        }).addTo(map);

        newMarker.bindTooltip(addr);

        newMarker.on('dragstart', () => { map.dragging.disable(); });
        newMarker.on('dragend', (e) => {
            map.dragging.enable(); 
            const newPos = e.target.getLatLng();
            stops[i].lat = parseFloat(newPos.lat.toFixed(6));
            stops[i].lng = parseFloat(newPos.lng.toFixed(6));
            markersMoved = true;
            showSaveButton(); 
        });

        stopMarkers[i] = newMarker;
    });

    if(!isSilent) alert("Admin Access Granted.");
}

function logout() {
    localStorage.removeItem('adminSession');
    // Move plus button back down before reload (optional but cleaner)
    const addBtn = document.getElementById('add-stop-btn');
    if (addBtn) addBtn.style.bottom = "20px";
    
    alert("Logged out.");
    location.reload(); 
}

function showSaveButton() {
    if (!document.getElementById('save-file-btn')) {
        const saveBtn = document.createElement('button');
        saveBtn.id = 'save-file-btn';
        saveBtn.innerText = "ðŸ’¾ SAVE MARKER CHANGES";
        saveBtn.style = "position:fixed; bottom:80px; right:10px; z-index:9999; background:#ffcc00; color:black; padding:15px; border-radius:8px; font-weight:bold; border:none; cursor:pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.6);";
        saveBtn.onclick = downloadUpdates;
        document.body.appendChild(saveBtn);
    }
}

function downloadUpdates() {
    let fileContent = "/* PERMANENT CODE UPDATE */\nconst stops = [\n";
    stops.forEach(s => {
        fileContent += `    {addr: "${s.addr}", lat: ${s.lat}, lng: ${s.lng}},\n`;
    });
    fileContent += "];";

    const blob = new Blob([fileContent], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Route_Updates_${new Date().toISOString().slice(0,10)}.txt`;
    link.click();
}

function prepareNewStop() {
    if (!navigator.geolocation) {
        alert("GPS is not supported by this browser.");
        return;
    }

    // Feedback for the user
    const originalText = document.getElementById('add-stop-btn').innerText;
    document.getElementById('add-stop-btn').innerText = "âŒ›";

    navigator.geolocation.getCurrentPosition((position) => {
        document.getElementById('add-stop-btn').innerText = "+";
        const lat = parseFloat(position.coords.latitude.toFixed(6));
        const lng = parseFloat(position.coords.longitude.toFixed(6));

        const houseInfo = prompt(`Location Captured!\nLat: ${lat}\nLng: ${lng}\n\nEnter House Number/Name:`);

        if (houseInfo) {
            if (isAdmin) {
                // ADMIN FEATURE: Add it directly to the map right now
                const newStop = { addr: houseInfo, lat: lat, lng: lng };
                stops.push(newStop);
                
                let newMarker = L.marker([lat, lng], {
                    draggable: true,
                    riseOnHover: true
                }).addTo(map);
                
                newMarker.bindTooltip(houseInfo);
                
                // Add the same dragging logic we use for existing markers
                newMarker.on('dragend', (e) => {
                    const pos = e.target.getLatLng();
                    newStop.lat = parseFloat(pos.lat.toFixed(6));
                    newStop.lng = parseFloat(pos.lng.toFixed(6));
                    showSaveButton();
                });

                stopMarkers.push(newMarker);
                markersMoved = true;
                showSaveButton();
                alert(`${houseInfo} added to map! Use the SAVE button to get the updated code.`);
            } else {
                // REGULAR USER: Send for confirmation
                submitToAdmin(houseInfo, lat, lng);
            }
        }
    }, (err) => {
        document.getElementById('add-stop-btn').innerText = "+";
        alert("GPS Error: Please ensure location services are enabled.");
    });
}

function submitToAdmin(name, lat, lng) {
    const newStopCode = `{addr: "${name}", lat: ${lat}, lng: ${lng}},`;
    const subject = encodeURIComponent("NEW CALL REQUEST: " + name);
    const body = encodeURIComponent("Please confirm and add this location to the route:\n\n" + newStopCode);
    
    window.location.href = `mailto:2000abw@gmail.com?subject=${subject}&body=${body}`;
    alert("Request generated. Please hit 'Send' on the email to notify the admin.");
}

// Ensure tooltips are active on load (Call this after stopMarkers array is filled)
setTimeout(addMarkerTooltips, 1000);
</script>
</body>
</html>