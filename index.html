<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logistics Pro - V5.6 Full List + Stop Count</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: #000000; --card: #1c1c1e; --accent: #0a84ff;
            --success: #32d74b; --warning: #ffd60a; --danger: #ff453a;
            --text: #ffffff; --text-dim: #8e8e93;
        }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; padding: 10px; overflow-x: hidden;
        }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999; display: flex;
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .btn-start {
            background: var(--accent); color: white; border: none;
            padding: 15px 40px; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 20px;
        }
        .header { padding: 5px 0; display: flex; justify-content: space-between; align-items: flex-end; }
        .header h1 { margin: 0; font-size: 14px; color: var(--text-dim); text-transform: uppercase; }
        
        .wct-box { text-align: right; }
        .wct-label { font-size: 9px; color: var(--text-dim); display: block; text-transform: uppercase; }
        #wct-val { color: var(--danger); font-size: 14px; font-weight: 800; }

        .prog-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-bottom: 10px; }
        #prog-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }

        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .big-val { font-size: 64px; font-weight: 800; color: var(--success); line-height: 1; }
        .addr-text { font-size: 20px; font-weight: 700; color: var(--accent); margin: 12px 0; min-height: 55px; text-align: center; }
        
        .arrived-alert { background: #1a321f !important; border: 2px solid var(--success); }
        
        .btn-group { display: flex; gap: 8px; }
        .btn-nav { flex: 1; border: none; padding: 18px; border-radius: 10px; font-weight: 700; font-size: 15px; }

        #reset-btn {
            position: absolute; top: 10px; right: 10px;
            background: #333; color: var(--danger); border: 1px solid var(--danger);
            padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 900; z-index: 20;
        }

        #dwell-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 8px; background: #333; z-index: 10; }
        #dwell-fill { height: 100%; width: 0%; background: var(--success); }

        #map-container { position: relative; margin-top: 10px; perspective: 1000px; overflow: hidden; border-radius: 10px; }
        #map { height: 400px; width: 100%; border: 1px solid #333; transition: transform 0.4s ease-out; }
        .map-3d { transform: rotateX(50deg) scale(1.3); height: 550px !important; margin-top: -75px; }

        #go-btn {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: var(--success); color: black; border: none;
            padding: 10px 20px; border-radius: 25px; font-weight: 900;
        }

        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; margin-top: 8px; }
        .calc-input { width: 100%; background: #000; border: 1px solid #333; color: #fff; font-size: 26px; padding: 12px; border-radius: 8px; text-align: center; box-sizing: border-box; }
        #gps-status { font-size: 10px; color: #8e8e93; text-align: center; margin-top: 6px; font-weight: bold; }
        
        .eta-box { text-align: right; color: var(--text-dim); font-size: 11px; font-weight: bold; margin-top: 10px; }
        #eta-val { color: var(--warning); font-size: 18px; display: block; }
        #dist-debug { font-size: 10px; color: var(--text-dim); position: absolute; top: 5px; left: 15px; }
        #skip-msg { font-size: 10px; color: var(--warning); position: absolute; top: 35px; right: 15px; font-weight: bold; }
        #run-indicator { color: var(--accent); font-weight: 900; letter-spacing: 1px; margin-bottom: 5px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="overlay">
        <div id="overlay-content">
            <h2 id="route-title" style="margin-bottom: 10px; letter-spacing: 2px;">LOADING...</h2>
            <div id="day-display" style="color: #8e8e93; font-size: 14px; margin-bottom: 20px;"></div>
            <button id="start-btn" class="btn-start" onclick="startApp()">START WORK</button>
        </div>
        <div id="off-work-msg" style="display:none;">
            <h1 style="color: var(--success); font-size: 40px;">SATURDAY</h1>
            <h3>NO WORK TONIGHT</h3>
        </div>
    </div>

    <div class="header">
        <div>
            <h1>Logistics Pro</h1>
            <div id="date-box" style="font-size: 12px; font-weight:bold; color: var(--text);"></div>
        </div>
        <div class="wct-box">
            <span class="wct-label">Est. Finish</span>
            <span id="wct-val">--:--</span>
        </div>
    </div>

    <div class="prog-bar"><div id="prog-fill"></div></div>

    <div class="card" id="main-card">
        <button id="reset-btn" onclick="resetRoute()">RESET</button>
        <div id="dist-debug">DIST: --m</div>
        <div id="skip-msg"></div>
        <div style="display:flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div class="big-val" id="rem-count">0</div>
                <div style="font-size: 10px; font-weight: 900; color: var(--text-dim); margin-left: 5px;">DROPS LEFT</div>
            </div>
            <div class="eta-box">
                <div id="run-indicator">RUN</div>
                ETA NEXT<br>
                <span id="eta-val">--:--</span>
            </div>
        </div>
        
        <div id="next-addr" class="addr-text">GPS Loading...</div>

        <div class="btn-group">
            <button class="btn-nav" style="background:#2c2c2e; color:white;" onclick="changeStop(-1)">BACK</button>
            <button class="btn-nav" style="background:var(--accent); color:white;" onclick="changeStop(1)">SKIP</button>
        </div>

        <div id="dwell-container"><div id="dwell-fill"></div></div>
    </div>

    <div id="map-container">
        <button id="go-btn" onclick="toggle3D()">GO</button>
        <div id="map"></div>
    </div>
    
    <div id="gps-status">GPS STANDBY</div>

    <div class="card" style="margin-top: 10px;">
        <input type="number" id="calc-in" class="calc-input" placeholder="Enter Total Items" oninput="doCalc()">
        <div class="calc-grid">
            <div><span id="p-out" style="color:var(--success); font-size: 28px; font-weight: 800;">0</span><br><small>PACKS</small></div>
            <div><span id="l-out" style="color:var(--warning); font-size: 28px; font-weight: 800;">0</span><br><small>LOOSE</small></div>
        </div>
    </div>

   <script>
    // --- 1. DATA CONTAINERS ---
    const townStops = [ 			{addr: "4a Napier Street", lat: 52.20757, lng: 0.13391},
			{addr: "17 Christchurch Street", lat: 52.20782, lng: 0.13303},
			{addr: "13 Christchurch Street", lat: 52.20760, lng: 0.13307},
			{addr: "34 Christchurch Street", lat: 52.20719, lng: 0.13311},
			{addr: "3 Willow Walk", lat: 52.20717, lng: 0.12752},
			{addr: "25 Brunswick Terrace", lat: 52.20895, lng: 0.13059},
			{addr: "17 Brunswick Terrace", lat: 52.20875, lng: 0.13067},
			{addr: "Ashtons Legal", lat: 52.20860, lng: 0.13666},
			{addr: "5a St Matthew's Gardens", lat: 52.20685, lng: 0.14145},
			{addr: "2 Ivy Court", lat: 52.20351, lng: 0.14381},
			{addr: "116 Sleaford Street", lat: 52.20391, lng: 0.14395},
			{addr: "Cambridge Women's Resource", lat: 52.20162, lng: 0.14021},
			{addr: "22 Sturton Street", lat: 52.20176, lng: 0.14070},
			{addr: "106 Sturton Street", lat: 52.20364, lng: 0.14053},
			{addr: "127 Sturton Street", lat: 52.20445, lng: 0.14025},
			{addr: "39b Abbey Walk", lat: 52.20560, lng: 0.14033},
			{addr: "20 Geldart Street", lat: 52.20555, lng: 0.13893},
			{addr: "5 Warkworth Street", lat: 52.20440, lng: 0.13027},
			{addr: "39 Warkworth Street", lat: 52.20448, lng: 0.13006},
			{addr: "26 Clarendon Street", lat: 52.20526, lng: 0.12827},
			{addr: "21 Victoria Street", lat: 52.20488, lng: 0.12719},
			{addr: "15 Elm Street", lat: 52.20596, lng: 0.12777},
			{addr: "Lensfield Hotel", lat: 52.19807, lng: 0.12360},
			{addr: "5 Pemberton Terrace", lat: 52.19692, lng: 0.12386},
			{addr: "21 Brookside", lat: 52.19700, lng: 0.12271},
			{addr: "6a Saxon Street", lat: 52.19776, lng: 0.12348},
			{addr: "6 Tennis Court Road", lat: 52.20129, lng: 0.12145},
			{addr: "Leverhulme", lat: 52.20066, lng: 0.12135},
			{addr: "3 Summerfield", lat: 52.19816, lng: 0.11149},
			{addr: "1b Summerfield", lat: 52.19833, lng: 0.11205},
			{addr: "25 Chedworth Street", lat: 52.19521, lng: 0.11156},
			{addr: "Newnham Nursery", lat: 52.19521, lng: 0.11156},
			{addr: "49 Grantchester Street", lat: 52.19416, lng: 0.11065},
			{addr: "32 Owlstone Road", lat: 52.19417, lng: 0.11132},
			{addr: "35 Owlstone Road", lat: 52.19412, lng: 0.11136},
			{addr: "50 Owlstone Road", lat: 52.19381, lng: 0.11147},
			{addr: "53 Owlstone Road", lat: 52.19361, lng: 0.11155},
			{addr: "23 Marlowe Road", lat: 52.19365, lng: 0.10797},
			{addr: "39 Eltisley Avenue", lat: 52.19443, lng: 0.10954},
			{addr: "24 Eltisley Avenue", lat: 52.19453, lng: 0.10965},
			{addr: "29 Hardwick Street", lat: 52.19557, lng: 0.10891},
			{addr: "14 Hardwick Street", lat: 52.19595, lng: 0.10894},
			{addr: "31 Millington Road", lat: 52.19470, lng: 0.10513},
			{addr: "102 Millington Lane", lat: 52.19411, lng: 0.10677},
			{addr: "8 St Marks Court", lat: 52.19712, lng: 0.10654},
			{addr: "15 St Marks Court", lat: 52.19764, lng: 0.10674},
			{addr: "45 Selwyn Road", lat: 52.19579, lng: 0.10241},
			{addr: "59 Selwyn Road", lat: 52.19583, lng: 0.10205},
			{addr: "48b Selwyn Road", lat: 52.19585, lng: 0.10142},
			{addr: "50 Selwyn Road", lat: 52.19586, lng: 0.10115},
			{addr: "3 Fulbrooke Road", lat: 52.19551, lng: 0.09958},
			{addr: "23 Fulbrooke Road", lat: 52.19563, lng: 0.09866},
			{addr: "25 Fulbrooke Road", lat: 52.19564, lng: 0.09858},
			{addr: "30 Fulbrooke Road", lat: 52.19566, lng: 0.09849},
			{addr: "34 Fulbrooke Road", lat: 52.19569, lng: 0.09823},
			{addr: "37 Fulbrooke Road", lat: 52.19569, lng: 0.09810},
			{addr: "33 Grantchester Road", lat: 52.19597, lng: 0.10047},
			{addr: "16 Grantchester Road", lat: 52.19614, lng: 0.10046},
			{addr: "29 Grantchester Road", lat: 52.19619, lng: 0.10047},
			{addr: "81 Barton Road", lat: 52.19762, lng: 0.09981},
			{addr: "86b Barton Road", lat: 52.19797, lng: 0.09845},
			{addr: "110 Barton Road", lat: 52.19855, lng: 0.09554},
			{addr: "University Laundry Farm", lat: 52.19743, lng: 0.08728},
			{addr: "12 Stukeley Close", lat: 52.19919, lng: 0.09693},
			{addr: "15 Gough Way", lat: 52.19990, lng: 0.09745},
			{addr: "41 Gough Way", lat: 52.19974, lng: 0.09465},
			{addr: "66 Gough Way", lat: 52.20031, lng: 0.09439},
			{addr: "67 Gough Way", lat: 52.20096, lng: 0.09441},
			{addr: "77 Gough Way", lat: 52.20177, lng: 0.09457},
			{addr: "79 Gough Way", lat: 52.20184, lng: 0.09462},
			{addr: "4 Spens Avenue", lat: 52.19967, lng: 0.09938},
			{addr: "57 Barton Road", lat: 52.19706, lng: 0.10232},
			{addr: "11 Barton Close", lat: 52.19782, lng: 0.10267},
			{addr: "13 Archway Court", lat: 52.19659, lng: 0.10310},
			{addr: "Monkey Puzzle Nursery", lat: 52.19788, lng: 0.10484},
			{addr: "Tyndale Lodge", lat: 52.19886, lng: 0.10357},
			{addr: "5a Selwyn Gardens", lat: 52.19968, lng: 0.10283},
			{addr: "4 Grange Court", lat: 52.20115, lng: 0.10422},
			{addr: "4 Marleborough Court", lat: 52.20065, lng: 0.10239},
			{addr: "5 Marleborough Court", lat: 52.20065, lng: 0.10239},
			{addr: "9a Herschel Road", lat: 52.20473, lng: 0.10073},
			{addr: "3 Adams Road", lat: 52.20614, lng: 0.10400},
			{addr: "Marks & Clerk", lat: 52.19660, lng: 0.12912},
			{addr: "Adams", lat: 52.20614, lng: 0.10400},
			{addr: "WSP", lat: 52.19655, lng: 0.12982},
			{addr: "21 Bateman Street", lat: 52.19541, lng: 0.12776},
			{addr: "University Cambridge Investment", lat: 52.19560, lng: 0.13070},
			{addr: "4 Claremont", lat: 52.19553, lng: 0.13119},
			{addr: "23 George Patemen Court", lat: 52.19582, lng: 0.13399},
			{addr: "7 Tenison Avenue", lat: 52.19647, lng: 0.13424},
			{addr: "41 Highsett", lat: 52.19643, lng: 0.13248},
			{addr: "11 Lyndewode Road", lat: 52.19723, lng: 0.13304},
			{addr: "26 Lyndewode Road", lat: 52.19721, lng: 0.13384},
			{addr: "8 St Barnabas Road", lat: 52.19720, lng: 0.13672},
			{addr: "15 St Barnabas Road", lat: 52.19681, lng: 0.13752},
			{addr: "33 St Barnabas Road", lat: 52.19809, lng: 0.13732},
			{addr: "38 St Barnabas Road", lat: 52.19809, lng: 0.13732},
			{addr: "39 St Barnabas Road", lat: 52.19830, lng: 0.13745},
			{addr: "68 St Barnabas Road", lat: 52.19876, lng: 0.13779},
			{addr: "184 Gwydir Street", lat: 52.20016, lng: 0.13855},
			{addr: "123 Gwydir Street", lat: 52.20158, lng: 0.13918},
			{addr: "91 Gwydir Street", lat: 52.20226, lng: 0.13932},
			{addr: "72 Kingston Street", lat: 52.20090, lng: 0.14016},
			{addr: "19 Eagle Street", lat: 52.20035, lng: 0.14126},
			{addr: "57 Tenison Road", lat: 52.19854, lng: 0.13577},
			{addr: "63 Tenison Road", lat: 52.19838, lng: 0.13568},
			{addr: "28 Emery Street", lat: 52.20133, lng: 0.13597},
			{addr: "18 Guest Road", lat: 52.20200, lng: 0.13470},
			{addr: "48 Glisson Road", lat: 52.19873, lng: 0.13353},
			{addr: "53 Glisson Road", lat: 52.19840, lng: 0.13310},
			{addr: "79 Hills Road", lat: 52.19395, lng: 0.13248},
			{addr: "123 Hills Road", lat: 52.19286, lng: 0.13341}, ];
    const villageStops = [ /* Paste Village Calls Here */ ];

    // --- 2. GLOBAL VARIABLES ---
    let stops = [];
    let index = 0;
    let map, userMarker, routeLine, dwellTimer, recenterTimer;
    let stopMarkers = []; 
    let lastLat = 52.238, lastLng = 0.182; 
    let isUserMovingMap = false;
    let countdownActive = false;
    
    const TRIGGER_DIST = 7; // Slightly wider to help with "Skip Ahead" detection

    // --- 3. APP INITIALIZATION (4 PM LOGIC) ---
    window.onload = function() {
        const now = new Date();
        let bizDate = new Date(now);
        
        // If it's before 4 PM, we are still on "Yesterday's" shift
        if (now.getHours() < 16) {
            bizDate.setDate(now.getDate() - 1);
        }

        const scheduleDay = bizDate.getDay(); 
        const routeTitle = document.getElementById('route-title');
        const runInd = document.getElementById('run-indicator');
        const calcPanel = document.getElementById('calc-panel');

        // Display the "Shift Date" (The night the work started)
        document.getElementById('date-box').innerText = bizDate.toLocaleDateString('en-GB', { 
            weekday: 'short', day: 'numeric', month: 'short' 
        }).toUpperCase();
        
        document.getElementById('day-display').innerText = bizDate.toLocaleDateString('en-GB', { 
            weekday: 'long' 
        }).toUpperCase();

        // Saturday Night (Shift starting Sat 4pm) = Off
        if (scheduleDay === 6) {
            document.getElementById('overlay-content').style.display = 'none';
            document.getElementById('off-work-msg').style.display = 'block';
            return;
        }

        // Village = Sun(0), Tue(2), Thu(4) | Town = Mon(1), Wed(3), Fri(5)
        const isVillageNight = (scheduleDay === 0 || scheduleDay === 2 || scheduleDay === 4);
        stops = isVillageNight ? villageStops : townStops;
        
        routeTitle.innerText = isVillageNight ? "VILLAGE RUN" : "TOWN RUN";
        runInd.innerText = isVillageNight ? "VILLAGE" : "TOWN";

        if (calcPanel) calcPanel.style.display = isVillageNight ? 'block' : 'none';

        const saved = localStorage.getItem('log_nav_idx');
        if (saved !== null && stops.length > 0) {
            index = Math.min(parseInt(saved), stops.length - 1);
            document.getElementById('start-btn').innerText = "RESUME AT STOP " + (index + 1);
        }
    };

    async function startApp() {
        if (stops.length === 0) return;
        document.getElementById('overlay').style.display = 'none';
        initMap();
        initGPS();
        updateUI();
    }

    // --- 4. MAP & GPS ---
    function initMap() {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([stops[0].lat, stops[0].lng], 17);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
        
        stops.forEach((stop, i) => {
            const marker = L.circleMarker([stop.lat, stop.lng], {
                radius: 6, fillColor: (i === index) ? "#ff453a" : "#ffd60a",
                color: "#fff", weight: 1, fillOpacity: 1
            }).addTo(map);
            stopMarkers.push(marker);
        });

        routeLine = L.polyline([], { color: '#0a84ff', weight: 8, opacity: 0.8 }).addTo(map);
        userMarker = L.circleMarker([0,0], { radius: 10, fillColor: "#fff", color: "#0a84ff", weight: 4, fillOpacity: 1 }).addTo(map);
        
        map.on('movestart', () => { isUserMovingMap = true; clearTimeout(recenterTimer); });
        map.on('moveend', () => { recenterTimer = setTimeout(() => { isUserMovingMap = false; recenterView(); }, 10000); });
    }

    function recenterView() {
        if (isUserMovingMap || !stops[index]) return;
        const bounds = L.latLngBounds([L.latLng(lastLat, lastLng), L.latLng(stops[index].lat, stops[index].lng)]);
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 18 });
    }

    function initGPS() {
        navigator.geolocation.watchPosition(pos => {
            lastLat = pos.coords.latitude;
            lastLng = pos.coords.longitude;
            userMarker.setLatLng([lastLat, lastLng]);
            
            // SMART SCAN: Check all remaining stops to see if we've skipped ahead
            for (let i = index; i < stops.length; i++) {
                let d = getDist(lastLat, lastLng, stops[i].lat, stops[i].lng);
                if (d < TRIGGER_DIST && !countdownActive) {
                    // If we found a match further down the list, jump to it
                    index = i; 
                    startHiddenCountdown();
                    break;
                }
            }

            document.getElementById('gps-status').innerText = `GPS ACTIVE (${Math.round(pos.coords.accuracy)}m)`;
            if (!isUserMovingMap) recenterView();
            fetchRoute();
        }, null, { enableHighAccuracy: true });
    }

    // --- 5. NAV & 2-MIN DROPS ---
    async function fetchRoute() {
        const dest = stops[index];
        if (!dest || !lastLat) return;
        try {
            const url = `https://router.project-osrm.org/route/v1/driving/${lastLng},${lastLat};${dest.lng},${dest.lat}?overview=full&geometries=geojson&steps=true`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.routes && data.routes[0]) {
                const route = data.routes[0];
                routeLine.setLatLngs(route.geometry.coordinates.map(c => [c[1], c[0]]));
                
                // Directions
                const steps = route.legs[0].steps;
                let dirText = "HEAD TOWARD STOP";
                if (steps.length > 1) {
                    const t = steps[1]; 
                    dirText = `IN ${Math.round(t.distance)}m: TAKE ${t.maneuver.modifier || 'TURN'} ONTO ${t.name || 'ROAD'}`;
                }
                document.getElementById('direction-text').innerText = dirText.toUpperCase();

                // ETA & Worst Case (2 mins per drop)
                const nextETA = new Date(Date.now() + (route.duration * 1000));
                document.getElementById('eta-val').innerText = nextETA.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

                const dropsRem = stops.length - index;
                const worstCase = new Date(Date.now() + ((route.duration + (dropsRem * 120)) * 1000));
                document.getElementById('worst-case').innerText = worstCase.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }
        } catch (e) { console.error(e); }
    }

    // --- 6. CORE APP LOGIC ---
    function startHiddenCountdown() {
        countdownActive = true;
        document.getElementById('main-card').classList.add('arrived-alert');
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]); 
        let time = 0;
        dwellTimer = setInterval(() => {
            time += 2; 
            document.getElementById('dwell-fill').style.width = time + "%";
            if (time >= 100) {
                clearInterval(dwellTimer);
                document.getElementById('main-card').classList.remove('arrived-alert');
                document.getElementById('dwell-fill').style.width = "0%";
                index++; // Move to the NEXT stop after the one we just arrived at
                countdownActive = false;
                updateUI();
            }
        }, 100);
    }

    function updateUI() {
        if (index >= stops.length) {
            document.getElementById('next-addr').innerText = "ROUTE COMPLETE";
            document.getElementById('rem-count').innerText = "0";
            return;
        }
        document.getElementById('next-addr').innerText = stops[index].addr;
        document.getElementById('rem-count').innerText = stops.length - index;
        document.getElementById('prog-fill').style.width = ((index / stops.length) * 100) + "%";
        localStorage.setItem('log_nav_idx', index);
        
        stopMarkers.forEach((m, i) => {
            if (i === index) m.setStyle({fillColor: "#ff453a", radius: 10});
            else if (i < index) m.setStyle({fillColor: "#444", radius: 5});
            else m.setStyle({fillColor: "#ffd60a", radius: 6});
        });
        recenterView();
        fetchRoute();
    }

    function getDist(l1, n1, l2, n2) {
        const R = 6371000;
        const dLat = (l2-l1) * Math.PI/180;
        const dLon = (n2-n1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function changeStop(dir) {
        clearInterval(dwellTimer);
        countdownActive = false;
        document.getElementById('main-card').classList.remove('arrived-alert');
        index = Math.max(0, Math.min(stops.length - 1, index + dir));
        updateUI();
    }

    function doCalc() {
        let v = document.getElementById('calc-in').value;
        document.getElementById('p-out').innerText = v ? Math.floor(v / 18) : 0;
        document.getElementById('l-out').innerText = v ? v % 18 : 0;
    }

    function resetRoute() {
        if (confirm("Reset route to Stop 1?")) {
            index = 0;
            localStorage.setItem('log_nav_idx', 0);
            updateUI();
        }
    }
</script>
</body>
</html>