<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logistics Pro - 3D Follow V3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: #000000; --card: #1c1c1e; --accent: #0a84ff;
            --success: #32d74b; --warning: #ffd60a; --danger: #ff453a;
            --text: #ffffff; --text-dim: #8e8e93;
        }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; padding: 10px; overflow-x: hidden;
        }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-start {
            background: var(--accent); color: white; border: none;
            padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600;
        }
        .header { padding: 5px 0; display: flex; justify-content: space-between; align-items: flex-end; }
        .header h1 { margin: 0; font-size: 14px; color: var(--text-dim); text-transform: uppercase; }
        
        .wct-box { text-align: right; }
        .wct-label { font-size: 9px; color: var(--text-dim); display: block; text-transform: uppercase; }
        #wct-val { color: var(--danger); font-size: 14px; font-weight: 800; }

        .prog-bar { width: 100%; height: 4px; background: #333; border-radius: 2px; margin-bottom: 10px; }
        #prog-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }

        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .big-val { font-size: 48px; font-weight: 800; color: var(--success); line-height: 1; }
        .addr-text { font-size: 19px; font-weight: 700; color: var(--accent); margin: 12px 0; min-height: 48px; text-align: center; }
        
        .btn-group { display: flex; gap: 8px; }
        .btn-nav { flex: 1; border: none; padding: 18px; border-radius: 10px; font-weight: 700; font-size: 15px; }

        /* Arrival Timer Bar */
        #dwell-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 6px; background: #333; }
        #dwell-fill { height: 100%; width: 0%; background: var(--success); transition: width 1s linear; }

        #map-container { position: relative; margin-top: 10px; perspective: 1000px; overflow: hidden; border-radius: 10px; }
        #map { 
            height: 400px; width: 100%; border: 1px solid #333;
            transition: transform 0.4s ease-out;
        }
        
        .map-3d {
            transform: rotateX(50deg) scale(1.3);
            height: 550px !important;
            margin-top: -75px;
        }

        .btn-reset-mini {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            width: 40px; height: 40px; background: rgba(28, 28, 30, 0.9);
            border: 2px solid var(--danger); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: var(--danger); font-size: 10px; font-weight: 800;
            overflow: hidden; touch-action: none;
        }

        #go-btn {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: var(--success); color: black; border: none;
            padding: 10px 20px; border-radius: 25px; font-weight: 900;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            letter-spacing: 1px;
        }

        #reset-fill {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: rgba(255, 69, 58, 0.4); pointer-events: none;
        }

        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; margin-top: 8px; }
        .calc-input { width: 100%; background: #000; border: 1px solid #333; color: #fff; font-size: 22px; padding: 8px; border-radius: 8px; text-align: center; box-sizing: border-box; }
        #gps-status { font-size: 9px; color: #555; text-align: center; margin-top: 4px; }
        
        .eta-box { text-align: right; color: var(--text-dim); font-size: 11px; font-weight: bold; }
        #eta-val { color: var(--warning); font-size: 18px; display: block; }
    </style>
</head>
<body>

    <div id="overlay">
        <h2 style="margin-bottom: 20px;">VILLAGE RUN</h2>
        <button id="start-btn" class="btn-start" onclick="startApp()">START SHIFT</button>
    </div>

    <div class="header">
        <div>
            <h1>Logistics Pro</h1>
            <div id="date-box" style="font-size: 10px; color: var(--text-dim);"></div>
        </div>
        <div class="wct-box">
            <span class="wct-label">Worst Case Finish</span>
            <span id="wct-val">--:--</span>
        </div>
    </div>

    <div class="prog-bar"><div id="prog-fill"></div></div>

    <div class="card">
        <div style="display:flex; justify-content: space-between; align-items: flex-start;">
            <div class="big-val" id="rem-count">0</div>
            <div class="eta-box">
                NEXT STOP<br>
                <span id="eta-val">--:--</span>
                <span style="font-size: 9px; opacity: 0.7;">STOPS REMAINING</span>
            </div>
        </div>
        
        <div id="next-addr" class="addr-text">Connecting...</div>

        <div class="btn-group">
            <button class="btn-nav" style="background:#2c2c2e; color:white;" onclick="changeStop(-1)">BACK</button>
            <button class="btn-nav" style="background:var(--danger); color:white;" onclick="changeStop(1)">SKIP / NEXT</button>
        </div>

        <div id="dwell-container"><div id="dwell-fill"></div></div>
    </div>

    <div id="map-container">
        <div id="hold-reset" class="btn-reset-mini">
            <div id="reset-fill"></div>
            <span style="z-index:1001">RST</span>
        </div>
        <button id="go-btn" onclick="toggle3D()">GO</button>
        <div id="map"></div>
    </div>
    
    <div id="gps-status">GPS STANDBY</div>

    <div class="card">
        <input type="number" id="calc-in" class="calc-input" placeholder="Enter Total Items" oninput="doCalc()">
        <div class="calc-grid">
            <div><span id="p-out" style="color:var(--success); font-size: 24px; font-weight: 800;">0</span><br><small>PACKS (18)</small></div>
            <div><span id="l-out" style="color:var(--warning); font-size: 24px; font-weight: 800;">0</span><br><small>LOOSE</small></div>
        </div>
    </div>

    <script>
        const stops = [
            {addr: "27 Priory Rd", lat: 52.238923, lng: 0.182703}, {addr: "The Old Vicarage", lat: 52.239562, lng: 0.186159},
            {addr: "Riverside House", lat: 52.256633, lng: 0.198421}, {addr: "49 Station Rd", lat: 52.263434, lng: 0.195682},
            {addr: "5 Payton Way", lat: 52.26457, lng: 0.19614}, {addr: "26 Burgess Rd", lat: 52.26542, lng: 0.19783},
            {addr: "13 Way Lane", lat: 52.26651, lng: 0.19284}, {addr: "44 Way Lane", lat: 52.26758, lng: 0.19361},
            {addr: "Bank Farmhouse", lat: 52.29088, lng: 0.22138}, {addr: "The Willows", lat: 52.27912, lng: 0.21036},
            {addr: "71 Capper Rd", lat: 52.27348, lng: 0.20126}, {addr: "Little Stars Nursery", lat: 52.27400, lng: 0.19717},
            {addr: "11 Capper Rd", lat: 52.27378, lng: 0.19688}, {addr: "8 Heron Walk", lat: 52.27265, lng: 0.19158},
            {addr: "5 Providence Way", lat: 52.27228, lng: 0.18778}, {addr: "23 Providence Way", lat: 52.27308, lng: 0.18802},
            {addr: "53 Denny End Rd", lat: 52.27202, lng: 0.18513}, {addr: "55 Denny End Rd", lat: 52.27200, lng: 0.18503},
            {addr: "57 Denny End Rd", lat: 52.27199, lng: 0.18492}, {addr: "2 Cookes Field", lat: 52.27132, lng: 0.18569},
            {addr: "Romil", lat: 52.27127, lng: 0.18137}, {addr: "6 Jubilee Cl", lat: 52.27049, lng: 0.18802},
            {addr: "14 Jubilee Cl", lat: 52.27114, lng: 0.18790}, {addr: "3 Vicarage Cl", lat: 52.26717, lng: 0.18968},
            {addr: "29 Vicarage Cl", lat: 52.26711, lng: 0.18795}, {addr: "16 Cambridge Rd", lat: 52.26535, lng: 0.18826},
            {addr: "15 Cambridge Rd", lat: 52.26503, lng: 0.18842}, {addr: "48 Cambridge Rd", lat: 52.26405, lng: 0.18729},
            {addr: "70 Cambridge Rd", lat: 52.26382, lng: 0.18612}, {addr: "139 Waterbeach Rd", lat: 52.26410, lng: 0.17774},
            {addr: "127 Waterbeach Rd", lat: 52.26409, lng: 0.17662}, {addr: "87 Waterbeach Rd", lat: 52.26414, lng: 0.17154},
            {addr: "8a Matthew Parker Cl", lat: 52.26327, lng: 0.16487}, {addr: "1 Abrahams Cl", lat: 52.26339, lng: 0.16327},
            {addr: "11 Abrahams Cl", lat: 52.26324, lng: 0.16395}, {addr: "12 Abrahams Cl", lat: 52.26324, lng: 0.16384},
            {addr: "14 Abrahams Cl", lat: 52.26326, lng: 0.16357}, {addr: "47 High St", lat: 52.26229, lng: 0.16350},
            {addr: "The Silver Cloud", lat: 52.25701, lng: 0.16330}, {addr: "22 David Bull Way", lat: 52.24602, lng: 0.16151},
            {addr: "40 Sutton Cl", lat: 52.24764, lng: 0.16078}, {addr: "26 Sutton Cl", lat: 52.24767, lng: 0.16172},
            {addr: "12 Burling Walk", lat: 52.24746, lng: 0.15966}, {addr: "3 Butcher Cl", lat: 52.24576, lng: 0.15558},
            {addr: "7 Butcher Cl", lat: 52.24555, lng: 0.15550}, {addr: "4 Bulteel Cl", lat: 52.24587, lng: 0.15792},
            {addr: "17 Froment Way", lat: 52.24663, lng: 0.15810}, {addr: "43 Willow Cres", lat: 52.24530, lng: 0.16357},
            {addr: "9 Goding Way", lat: 52.24307, lng: 0.16677}, {addr: "15 Pearson Cl", lat: 52.24073, lng: 0.16648},
            {addr: "6 Milton Court", lat: 52.24375, lng: 0.16298}, {addr: "2 Old School Ln", lat: 52.24242, lng: 0.16321},
            {addr: "14 Old School Ln", lat: 52.24210, lng: 0.16393}, {addr: "58 Old School Ln", lat: 52.24091, lng: 0.16543},
            {addr: "57 Old School Ln", lat: 52.24125, lng: 0.16596}, {addr: "21 Old School Ln", lat: 52.24213, lng: 0.16422},
            {addr: "64 Coles Rd", lat: 52.24195, lng: 0.16199}, {addr: "27 Walkling Way", lat: 52.24160, lng: 0.16080},
            {addr: "11 High St", lat: 52.24320, lng: 0.16090}, {addr: "9 Fox's Cl", lat: 52.24439, lng: 0.16089},
            {addr: "Tanglin Butt Ln", lat: 52.24407, lng: 0.15829}, {addr: "7 Lyndhurst Cl", lat: 52.24499, lng: 0.15809},
            {addr: "49 Butt Ln", lat: 52.24464, lng: 0.15547}, {addr: "272 The Rowans", lat: 52.24164, lng: 0.15782},
            {addr: "37 The Oaks", lat: 52.24359, lng: 0.15747}, {addr: "27 The Oaks", lat: 52.24335, lng: 0.15715},
            {addr: "10 The Elms", lat: 52.24318, lng: 0.15609}, {addr: "22 The Elms", lat: 52.24366, lng: 0.15651},
            {addr: "13 The Elms", lat: 52.24377, lng: 0.15616}, {addr: "235 High St", lat: 52.24244, lng: 0.15507},
            {addr: "190 The Rowans", lat: 52.24211, lng: 0.15687}, {addr: "118 The Rowans", lat: 52.24138, lng: 0.15593},
            {addr: "120 The Rowans", lat: 52.24139, lng: 0.15608}, {addr: "14 The Sycamores", lat: 52.24111, lng: 0.15375},
            {addr: "62 The Rowans", lat: 52.24030, lng: 0.15486}, {addr: "30 The Rowans", lat: 52.23931, lng: 0.15567},
            {addr: "12 Benet Cl", lat: 52.24015, lng: 0.15636}, {addr: "38 North Lodge pk", lat: 52.24516, lng: 0.16846},
            {addr: "Enterprise House", lat: 52.25577, lng: 0.17561}, {addr: "The Retreat", lat: 52.25603, lng: 0.17583},
            {addr: "82 Green End Rd", lat: 52.27104, lng: 0.16312}, {addr: "Alborough Farm", lat: 52.29310, lng: 0.15483},
            {addr: "73 Racecourse View", lat: 52.28598, lng: 0.13563}, {addr: "39 Beach Rd", lat: 52.28531, lng: 0.13114},
            {addr: "30 Leopold Walk", lat: 52.28434, lng: 0.12478}, {addr: "13 Brenda Gautrey Way", lat: 52.28495, lng: 0.12842},
            {addr: "1 Calvin Cl", lat: 52.28582, lng: 0.13417}, {addr: "10 Beach Rd", lat: 52.28635, lng: 0.13011},
            {addr: "116 Rooks St", lat: 52.28663, lng: 0.12918}, {addr: "106 Rooks St", lat: 52.28684, lng: 0.12905},
            {addr: "87a Rooks St", lat: 52.28744, lng: 0.13076}, {addr: "58 Denmark Rd", lat: 52.28608, lng: 0.12911},
            {addr: "56 Denmark Rd", lat: 52.28610, lng: 0.12873}, {addr: "32 Denmark Rd", lat: 52.28555, lng: 0.12728},
            {addr: "1a Cundell Dr", lat: 52.28729, lng: 0.12824}, {addr: "7 Cundell Dr", lat: 52.28748, lng: 0.12912},
            {addr: "7 Corbett St", lat: 52.28808, lng: 0.12650}, {addr: "19 Corbett St", lat: 52.28803, lng: 0.12751},
            {addr: "The Gables", lat: 52.28885, lng: 0.13071}, {addr: "48 Rooks St", lat: 52.28869, lng: 0.12930},
            {addr: "55 Margett St", lat: 52.28844, lng: 0.12833}, {addr: "30 Margett St", lat: 52.28892, lng: 0.12788},
            {addr: "11 Margett St", lat: 52.28957, lng: 0.12676}, {addr: "153 High St", lat: 52.29030, lng: 0.12648},
            {addr: "148 High St", lat: 52.29048, lng: 0.12648}, {addr: "140 High St", lat: 52.29085, lng: 0.12686},
            {addr: "15 Courtyard Way", lat: 52.29334, lng: 0.12544}, {addr: "19 Courtyard Way", lat: 52.29343, lng: 0.12564},
            {addr: "13 Courtyard Way", lat: 52.29331, lng: 0.12560}, {addr: "7 Moores Court", lat: 52.29244, lng: 0.12589},
            {addr: "8 Moores Court", lat: 52.29243, lng: 0.12582}, {addr: "31 Broad Lane", lat: 52.29228, lng: 0.12534},
            {addr: "14 Tenison Manor", lat: 52.29212, lng: 0.12317}, {addr: "11 Woodlark Dr", lat: 52.29070, lng: 0.12170},
            {addr: "30 Woodlark Dr", lat: 52.29060, lng: 0.12134}, {addr: "8 The Herons", lat: 52.28971, lng: 0.12378},
            {addr: "27 Kestrel Cl", lat: 52.29125, lng: 0.12517}, {addr: "15 Bullfinch Way", lat: 52.29162, lng: 0.12465},
            {addr: "92 High St", lat: 52.29286, lng: 0.12867}, {addr: "83 High St", lat: 52.29306, lng: 0.12901},
            {addr: "71 High St", lat: 52.29366, lng: 0.12939}, {addr: "2 Ivatt St", lat: 52.29402, lng: 0.12937},
            {addr: "5 Ivatt St", lat: 52.29426, lng: 0.12888}, {addr: "38 Ivatt St", lat: 52.29510, lng: 0.12783},
            {addr: "41 High St", lat: 52.29452, lng: 0.13018}, {addr: "Screens & Graphics", lat: 52.29544, lng: 0.13126},
            {addr: "19 High St", lat: 52.29564, lng: 0.13127}, {addr: "13 High St", lat: 52.29592, lng: 0.13162},
            {addr: "Wooden House", lat: 52.29787, lng: 0.13250}, {addr: "Voland Roofing", lat: 52.29820, lng: 0.13321},
            {addr: "DB Technology", lat: 52.30256, lng: 0.14977}, {addr: "Lost Acres", lat: 52.30385, lng: 0.15248},
            {addr: "4 Beagle Court", lat: 52.28788, lng: 0.12562}, {addr: "277 High St", lat: 52.28618, lng: 0.12619},
            {addr: "7 Lacks Cl", lat: 52.28529, lng: 0.12366}, {addr: "4 Wilkin Walk", lat: 52.28466, lng: 0.12267},
            {addr: "324 High St", lat: 52.28373, lng: 0.12227}, {addr: "330 High St", lat: 52.28351, lng: 0.12187},
            {addr: "7 Ellis Cl", lat: 52.28248, lng: 0.11956}, {addr: "20 Rampton Rd", lat: 52.28325, lng: 0.11935},
            {addr: "1a Oakington Rd", lat: 52.28344, lng: 0.11770}, {addr: "11 Worland Way", lat: 52.28389, lng: 0.11429},
            {addr: "6 The Rowells", lat: 52.28325, lng: 0.11407}, {addr: "47 Clarke Cl", lat: 52.28244, lng: 0.11043},
            {addr: "92 Clarke Cl", lat: 52.28435, lng: 0.11391}, {addr: "4 New Close", lat: 52.28434, lng: 0.11791},
            {addr: "75 Rampton Rd", lat: 52.28491, lng: 0.11591}, {addr: "86 Rampton Rd", lat: 52.28556, lng: 0.11520},
            {addr: "113 Rampton Rd", lat: 52.28618, lng: 0.11288}, {addr: "67 Groves Way", lat: 52.28461, lng: 0.11226},
            {addr: "88 Lambs Ln", lat: 52.28568, lng: 0.11700}, {addr: "8 Pelham Way", lat: 52.28533, lng: 0.11856},
            {addr: "18 Wilkin Walk", lat: 52.28500, lng: 0.12213}, {addr: "49 Pelham Way", lat: 52.28389, lng: 0.12056},
            {addr: "62 Lambs Ln", lat: 52.28282, lng: 0.12461}, {addr: "Ladybird Nursery", lat: 52.28312, lng: 0.12561},
            {addr: "Chestnut Nursery", lat: 52.28332, lng: 0.12631}, {addr: "Cottenham Primary", lat: 52.28352, lng: 0.12691},
            {addr: "31 Victory Way", lat: 52.28422, lng: 0.12761}, {addr: "30 Lambs Ln", lat: 52.28452, lng: 0.12831},
            {addr: "21 Victory Way", lat: 52.28482, lng: 0.12891}, {addr: "5 Lambs Row", lat: 52.28522, lng: 0.12961},
            {addr: "7 Harlestones Rd", lat: 52.28582, lng: 0.13031}, {addr: "46 Wilkin Walk", lat: 52.28652, lng: 0.13161},
            {addr: "21 Franklin Gardens", lat: 52.28722, lng: 0.13291}, {addr: "38 Franklin Gardens", lat: 52.28752, lng: 0.13361},
            {addr: "17 Lyles Rd", lat: 52.28822, lng: 0.13461}, {addr: "16 Lyles Rd", lat: 52.28852, lng: 0.13531},
            {addr: "6 Lyles Rd", lat: 52.28912, lng: 0.13631}, {addr: "1 Staff House", lat: 52.28982, lng: 0.13561},
            {addr: "2 Morgans", lat: 52.28852, lng: 0.13831}, {addr: "3 Foundry Cl", lat: 52.28722, lng: 0.13961},
            {addr: "41 Dunstall Field", lat: 52.28582, lng: 0.14131}, {addr: "15 Dunstall Field", lat: 52.28522, lng: 0.14191},
            {addr: "14 Dunstall Field", lat: 52.28512, lng: 0.14211}, {addr: "38 Dunstall Field", lat: 52.28552, lng: 0.14261},
            {addr: "27 Dunstall Field", lat: 52.28542, lng: 0.14231}, {addr: "34 Histon Rd", lat: 52.28352, lng: 0.14391}
        ];

        let index = 0;
        let map, userMarker, routeLine;
        let stopMarkers = []; 
        let lastLat = 52.238, lastLng = 0.182;
        let isUserMovingMap = false;
        let moveTimeout;
        let is3DMode = false;
        let userHeading = 0;
        
        // Timer Globals
        let dwellTimer = null;
        let dwellCount = 0;
        let wakeLock = null;

        // Reset Globals
        let holdTimer;
        let holdDuration = 2000; 

        window.onload = function() {
            document.getElementById('date-box').innerText = new Date().toLocaleDateString();
            const saved = localStorage.getItem('log_nav_idx');
            if (saved) {
                index = Math.min(parseInt(saved), stops.length - 1);
                document.getElementById('start-btn').innerText = "RESUME AT " + (index + 1);
            }
            setupResetButton();
        };

        // Screen Wake Lock
        async function stayAwake() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log("Wake Lock Active");
                }
            } catch (err) {}
        }

        function toggle3D() {
            is3DMode = !is3DMode;
            const mapEl = document.getElementById('map');
            const goBtn = document.getElementById('go-btn');
            
            // Trigger Wake Lock on GO click
            stayAwake();

            if (is3DMode) {
                mapEl.classList.add('map-3d');
                goBtn.innerText = "EXIT";
                goBtn.style.background = "var(--danger)";
                map.setView([lastLat, lastLng], 19, { animate: true });
            } else {
                mapEl.classList.remove('map-3d');
                mapEl.style.transform = "rotateZ(0deg)";
                goBtn.innerText = "GO";
                goBtn.style.background = "var(--success)";
                updateUI(); 
            }
        }

        function setupResetButton() {
            const btn = document.getElementById('hold-reset');
            const fill = document.getElementById('reset-fill');

            const startHold = (e) => {
                e.preventDefault();
                fill.style.transition = `height ${holdDuration}ms linear`;
                fill.style.height = "100%";
                holdTimer = setTimeout(() => {
                    index = 0;
                    localStorage.removeItem('log_nav_idx');
                    updateUI();
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    endHold();
                }, holdDuration);
            };

            const endHold = () => {
                clearTimeout(holdTimer);
                fill.style.transition = "height 0.2s ease-out";
                fill.style.height = "0%";
            };

            btn.addEventListener('mousedown', startHold);
            btn.addEventListener('touchstart', startHold);
            btn.addEventListener('mouseup', endHold);
            btn.addEventListener('touchend', endHold);
        }

        function startApp() {
            document.getElementById('overlay').style.display = 'none';
            stayAwake();
            initMap();
            initGPS();
            updateUI();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([lastLat, lastLng], 17);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
            
            stops.forEach((stop, i) => {
                const marker = L.circleMarker([stop.lat, stop.lng], {
                    radius: 6,
                    fillColor: (i === index) ? "#ff453a" : "#ffd60a",
                    color: "#fff",
                    weight: 1,
                    fillOpacity: 1
                }).addTo(map);
                stopMarkers.push(marker);
            });

            routeLine = L.polyline([], { color: '#0a84ff', weight: 8, opacity: 0.9, lineJoin: 'round' }).addTo(map);
            userMarker = L.circleMarker([0,0], { radius: 10, fillColor: "#fff", color: "#0a84ff", weight: 4, fillOpacity: 1 }).addTo(map);

            map.on('movestart', () => {
                isUserMovingMap = true;
                clearTimeout(moveTimeout);
                moveTimeout = setTimeout(() => isUserMovingMap = false, 8000);
            });
        }

        // 5-Second Presence Logic
        function checkPresence(uLat, uLng) {
            const target = stops[index];
            if (!target) return;

            const dist = getDist(uLat, uLng, target.lat, target.lng);
            const statusEl = document.getElementById('gps-status');
            const progressEl = document.getElementById('dwell-fill');

            if (dist < 20) { // Within 20 meters
                if (!dwellTimer) {
                    statusEl.innerText = "AT STOP: REGISTERING IN 5S...";
                    statusEl.style.color = "var(--success)";
                    dwellCount = 0;
                    dwellTimer = setInterval(() => {
                        dwellCount++;
                        progressEl.style.width = (dwellCount * 20) + "%";
                        if (dwellCount >= 5) {
                            clearInterval(dwellTimer);
                            dwellTimer = null;
                            progressEl.style.width = "0%";
                            index++;
                            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                            updateUI();
                        }
                    }, 1000);
                }
            } else {
                if (dwellTimer) {
                    clearInterval(dwellTimer);
                    dwellTimer = null;
                    dwellCount = 0;
                    progressEl.style.width = "0%";
                    statusEl.innerText = "GPS ACTIVE";
                    statusEl.style.color = "#555";
                }
            }
        }

        async function fetchRoute() {
            const dest = stops[index];
            if (!dest) {
                document.getElementById('eta-val').innerText = "DONE";
                document.getElementById('wct-val').innerText = "FINISHED";
                return;
            }
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${lastLng},${lastLat};${dest.lng},${dest.lat}?overview=full&geometries=geojson`;
                const res = await fetch(url);
                const data = await res.json();
                
                let driveTimeToNext = 0;
                if (data.routes && data.routes[0]) {
                    const route = data.routes[0];
                    driveTimeToNext = route.duration;
                    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
                    routeLine.setLatLngs(coords);
                    
                    const arrivalTime = new Date(Date.now() + driveTimeToNext * 1000);
                    document.getElementById('eta-val').innerText = arrivalTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    if (!isUserMovingMap) {
                        if (is3DMode) {
                            map.panTo([lastLat, lastLng], {animate: true});
                        } else {
                            map.fitBounds(L.latLngBounds(coords), { padding: [50, 50], maxZoom: 18 });
                        }
                    }
                }

                // WCT Calculation
                let totalTravelSeconds = driveTimeToNext;
                const stopsRemaining = stops.length - index;
                const totalServiceSeconds = stopsRemaining * 120; // 2 mins per stop

                for (let i = index; i < stops.length - 1; i++) {
                    const legDist = getDist(stops[i].lat, stops[i].lng, stops[i+1].lat, stops[i+1].lng);
                    totalTravelSeconds += (legDist * 1.4) / 9; 
                }

                const finishDate = new Date(Date.now() + (totalTravelSeconds * 1000) + (totalServiceSeconds * 1000));
                document.getElementById('wct-val').innerText = finishDate.toLocaleTimeString([], { 
                    hour: '2-digit', minute: '2-digit' 
                });

            } catch (e) { 
                console.error("Route error:", e);
            }
        }

        function updateUI() {
            const current = stops[index];
            document.getElementById('rem-count').innerText = stops.length - index;
            document.getElementById('next-addr').innerText = current ? current.addr : "FINISHED";
            document.getElementById('prog-fill').style.width = ((index / stops.length) * 100) + "%";
            localStorage.setItem('log_nav_idx', index);

            stopMarkers.forEach((m, i) => {
                if (i === index) {
                    m.setStyle({ fillColor: "#ff453a", radius: 10, weight: 3 });
                    m.bringToFront();
                } else if (i < index) {
                    m.setStyle({ fillColor: "#444", radius: 5, weight: 1 });
                } else {
                    m.setStyle({ fillColor: "#ffd60a", radius: 6, weight: 1 });
                }
            });
            fetchRoute();
        }

        function initGPS() {
            navigator.geolocation.watchPosition((pos) => {
                lastLat = pos.coords.latitude;
                lastLng = pos.coords.longitude;
                userHeading = pos.coords.heading || 0;

                checkPresence(lastLat, lastLng);

                if (document.getElementById('dwell-fill').style.width === "0%") {
                    document.getElementById('gps-status').innerText = `GPS ACCURACY: ${pos.coords.accuracy.toFixed(1)}m`;
                }

                userMarker.setLatLng([lastLat, lastLng]);
                
                if (is3DMode) {
                    const mapEl = document.getElementById('map');
                    mapEl.style.transform = `rotateX(50deg) rotateZ(${-userHeading}deg) scale(1.3)`;
                    if(!isUserMovingMap) map.panTo([lastLat, lastLng]);
                }

                if (!isUserMovingMap) fetchRoute();
            }, null, { enableHighAccuracy: true });
        }

        function changeStop(dir) {
            index = Math.max(0, Math.min(stops.length - 1, index + dir));
            updateUI();
        }

        function doCalc() {
            let v = document.getElementById('calc-in').value;
            document.getElementById('p-out').innerText = v ? Math.floor(v / 18) : 0;
            document.getElementById('l-out').innerText = v ? v % 18 : 0;
        }

        function getDist(l1, n1, l2, n2) {
            const R = 6371000;
            const dLat = (l2-l1) * Math.PI/180;
            const dLon = (n2-n1) * Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Re-engage wake lock if app is minimized and brought back
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') stayAwake();
        });
    </script>
</body>
</html>